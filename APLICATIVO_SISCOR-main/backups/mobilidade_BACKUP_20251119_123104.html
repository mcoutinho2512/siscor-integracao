{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobilidade Urbana - SISCOR</title>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- COR Styles -->
    <link rel="stylesheet" href="{% static 'mapa_novo/css/cor_navbar.css' %}">
    <link rel="stylesheet" href="{% static 'mapa_novo/css/cor_menu.css' %}">
    <link rel="stylesheet" href="{% static 'mapa_novo/css/dark_theme.css' %}">
    <link rel="stylesheet" href="{% static 'mapa_novo/css/dark_mode.css' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

    <!-- Design System Padronizado COR -->
    <link rel="stylesheet" href="{% static 'mapa_novo/css/cor_design_system.css' %}">
    <link rel="stylesheet" href="{% static 'mapa_novo/css/cor_components.css' %}">
    <link rel="stylesheet" href="{% static 'mapa_novo/css/sistemas_padronizados.css' %}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            overflow-x: hidden;
            overflow-y: auto;
            height: auto;
            min-height: 100vh;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }

        /* Container Principal */
        .dashboard-container {
            padding: 160px 20px 20px 20px;
            max-width: 1600px;
            margin: 0 auto;
            height: auto;
            min-height: calc(100vh - 160px);
        }

        /* Header Padronizado */
        .dashboard-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            color: #f8fafc;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f8fafc;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .header-stat {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #f59e0b;
            margin-bottom: 4px;
        }

        .header-stat-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Sections */
        .mob-section {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mob-section-title {
            color: #f8fafc;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mob-section-title i {
            color: #f59e0b;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .linha-card {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .linha-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--linha-cor, #f59e0b);
        }

        .linha-card:hover {
            transform: translateY(-4px);
            border-color: var(--linha-cor, #f59e0b);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);
        }

        .linha-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .linha-nome {
            font-weight: 700;
            color: #f8fafc;
            font-size: 18px;
        }

        .linha-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .linha-status.normal {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .linha-status.alerta {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .linha-status.obras {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .linha-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .linha-info-item {
            font-size: 13px;
            color: #94a3b8;
        }

        .linha-info-item strong {
            color: #f8fafc;
            display: block;
            margin-top: 2px;
            font-size: 16px;
        }

        /* Bike Rio Cards */
        .bike-card {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s;
        }

        .bike-card:hover {
            border-color: #10b981;
            transform: translateY(-2px);
        }

        .bike-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .bike-nome {
            font-weight: 600;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bike-nome i {
            color: #10b981;
        }

        .bike-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .bike-status.sem-bikes {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .bike-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
        }

        .bike-stat {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .bike-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #10b981;
        }

        .bike-stat-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* Status do Transito */
        .transito-status {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            border: 2px solid;
        }

        .transito-status.nivel-1 {
            border-color: #10b981;
        }

        .transito-status.nivel-2 {
            border-color: #f59e0b;
        }

        .transito-status.nivel-3 {
            border-color: #ef4444;
        }

        .transito-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .transito-descricao {
            font-size: 24px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 8px;
        }

        .transito-detalhes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .transito-detail {
            text-align: center;
        }

        .transito-detail-value {
            font-size: 20px;
            font-weight: 700;
            color: #f8fafc;
        }

        .transito-detail-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .loading i {
            font-size: 48px;
            animation: spin 1s linear infinite;
            color: #f59e0b;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Modal de Rotas */
        .rota-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .rota-modal.active {
            display: flex;
        }

        .rota-modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .rota-modal-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rota-modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .rota-modal-title i {
            font-size: 24px;
        }

        .rota-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 20px;
            transition: all 0.2s;
        }

        .rota-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .nova-rota-body {
            padding: 24px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            max-height: calc(90vh - 180px);
            position: relative;
            /* âœ… ADICIONAR */
            z-index: 1;
            /* âœ… ADICIONAR */
        }

        /* Estilizar scrollbar */
        .nova-rota-body::-webkit-scrollbar {
            width: 8px;
        }

        .nova-rota-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .nova-rota-body::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.5);
            border-radius: 4px;
        }

        .nova-rota-body::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.7);
        }

        .rota-info-grid {
            display: grid;
            gap: 16px;
        }

        .rota-info-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rota-info-label {
            color: #94a3b8;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rota-info-label i {
            color: #f59e0b;
        }

        .rota-info-value {
            color: #f8fafc;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.5;
        }

        .rota-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .rota-stat-card {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .rota-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #f59e0b;
        }

        .rota-stat-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
            text-transform: uppercase;
        }

        .rota-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .rota-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rota-modal-btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .rota-modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .rota-modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #f8fafc;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .rota-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Painel de Controle de Rotas - CORRIGIDO */
        .rotas-control-panel {
            position: fixed;
            top: 160px;
            right: 20px;
            width: 320px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 999;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .rotas-control-panel.minimized {
            transform: translateX(360px);
        }

        .rotas-panel-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 16px 20px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .rotas-panel-title {
            color: white;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rotas-panel-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .rotas-panel-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .rotas-panel-body {
            padding: 20px;
        }

        .rotas-section {
            margin-bottom: 24px;
        }

        .rotas-section-title {
            color: #f8fafc;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rotas-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .rotas-stat-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .rotas-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #f59e0b;
        }

        .rotas-stat-label {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .rotas-filter {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rotas-filter:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .rotas-filter-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rotas-filter-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        .rotas-filter-text {
            color: #f8fafc;
            font-size: 14px;
            font-weight: 500;
        }

        .rotas-filter-count {
            color: #94a3b8;
            font-size: 12px;
        }

        .rotas-toggle-switch {
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            position: relative;
            transition: background 0.2s;
        }

        .rotas-toggle-switch.active {
            background: #10b981;
        }

        .rotas-toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            transition: transform 0.2s;
        }

        .rotas-toggle-switch.active .rotas-toggle-slider {
            transform: translateX(20px);
        }

        .rotas-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f8fafc;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .rotas-action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .rotas-action-btn i {
            font-size: 14px;
        }

        /* Legenda de cores */
        .rotas-legend {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
        }

        .rotas-legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .rotas-legend-item:last-child {
            margin-bottom: 0;
        }

        .rotas-legend-line {
            width: 30px;
            height: 4px;
            border-radius: 2px;
        }

        .rotas-legend-label {
            color: #cbd5e1;
            font-size: 13px;
            flex: 1;
        }

        .rotas-legend-count {
            color: #64748b;
            font-size: 12px;
            font-weight: 600;
        }

        /* Botao flutuante de controle */
        .map-control-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .map-control-btn.visible {
            display: flex;
        }

        .map-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.5);
        }

        .map-control-btn .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #0f172a;
        }

        /* Modo de desenho */
        .desenho-mode-indicator {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
        }

        .desenho-mode-indicator.active {
            display: flex;
        }

        #mobilidade-map {
            position: relative;
            z-index: 1;
        }

        /* Garantir que o mapa capture eventos quando em modo de desenho */
        #mobilidade-map.desenho-ativo {
            z-index: 1000 !important;
        }

        .leaflet-container {
            cursor: inherit !important;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            }

            50% {
                box-shadow: 0 4px 20px rgba(16, 185, 129, 0.6);
            }
        }

        /* Animacao para quando o modal fechar */
        .nova-rota-modal.fechando {
            animation: modalFadeOut 0.3s ease forwards;
        }

        @keyframes modalFadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        /* Indicador mais visivel */
        .desenho-mode-indicator {
            animation: pulse-draw 2s infinite, slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes pulse-draw {

            0%,
            100% {
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            }

            50% {
                box-shadow: 0 4px 25px rgba(16, 185, 129, 0.7);
            }
        }

        /* Animacao para marcadores do Waze */
        @keyframes pulse-waze {

            0%,
            100% {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
                transform: scale(1.1);
            }
        }

        /* Hover suave para marcadores Waze */
        .waze-marker-icon:hover {
            transform: scale(1.15) !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5) !important;
            z-index: 10000 !important;
        }

        .waze-marker-icon:active {
            transform: scale(1.05) !important;
        }

        /* Garantir que o marcador esteja sempre visivel */
        .waze-marker {
            z-index: 1000 !important;
            pointer-events: auto !important;
        }

        .waze-marker .waze-marker-icon {
            pointer-events: auto !important;
        }

        .desenho-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 12px;
            z-index: 1000;
        }

        .desenho-controls.active {
            display: flex;
        }

        .desenho-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #10b981;
            color: #0f172a;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .desenho-btn:hover {
            background: #10b981;
            color: white;
            transform: translateY(-2px);
        }

        .desenho-btn.cancel {
            border-color: #ef4444;
        }

        .desenho-btn.cancel:hover {
            background: #ef4444;
        }

        /* Modal de Nova Rota */
        .nova-rota-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .nova-rota-modal.active {
            display: flex;
        }

        .nova-rota-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            /* âœ… AUMENTADO */
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.3s ease;
            display: flex;
            flex-direction: column;
            /* âœ… IMPORTANTE */
        }

        .nova-rota-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        .nova-rota-header h3 {
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
        }

        .nova-rota-body {
            padding: 24px;
            max-height: calc(85vh - 160px);
            /* âœ… AJUSTADO */
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            color: #f8fafc;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #10b981;
            background: rgba(255, 255, 255, 0.08);
        }

        .form-select {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: #f8fafc;
            font-size: 14px;
            cursor: pointer;
        }

        .form-select option {
            background: #1e293b;
            color: #f8fafc;
        }

        .nova-rota-footer {
            padding: 20px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            /* âœ… NAƒO ENCOLHE */
        }

        .nova-rota-btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nova-rota-btn.primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .nova-rota-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .nova-rota-btn.primary:active {
            transform: translateY(0);
        }

        .nova-rota-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #f8fafc;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .nova-rota-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nova-rota-btn.secondary:active {
            transform: translateY(0);
        }

        .search-btn {
            width: 100%;
            margin-top: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
            border: 2px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-btn:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.25) 0%, rgba(5, 150, 105, 0.25) 100%);
            border-color: #10b981;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .btn-calcular-rota {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 16px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-calcular-rota:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .btn-calcular-rota:active {
            transform: translateY(-1px);
        }

        .btn-calcular-rota i {
            font-size: 20px;
            animation: pulse-icon 2s infinite;
        }

        @keyframes pulse-icon {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .btn-iniciar-desenho {
            padding: 18px 40px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 17px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
            position: relative;
            overflow: hidden;
            pointer-events: auto !important;
            /* âœ… JA EXISTE */
            z-index: 10000 !important;
            /* âœ… AUMENTAR MUITO O Z-INDEX */
        }

        .btn-iniciar-desenho::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-iniciar-desenho:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-iniciar-desenho:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        .btn-iniciar-desenho:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn-iniciar-desenho i {
            font-size: 22px;
            position: relative;
            z-index: 1;
        }

        .btn-iniciar-desenho span {
            position: relative;
            z-index: 1;
        }


        /* MODAL SUPER PROFISSIONAL */
        .rota-modal-body {
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(80vh - 160px);
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        }

        /* Estilizar scrollbar */
        .rota-modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .rota-modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .rota-modal-body::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 4px;
        }

        .rota-modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.7);
        }

        /* Modal Waze - Layout Profissional */
        .waze-modal-section {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .waze-modal-section:last-child {
            border-bottom: none;
        }

        .waze-section-title {
            color: #94a3b8;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .waze-hero {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.1) 100%);
            padding: 24px;
            text-align: center;
            border-bottom: 2px solid rgba(59, 130, 246, 0.3);
        }

        .waze-hero-icon {
            font-size: 48px;
            margin-bottom: 12px;
            animation: pulse-icon 2s infinite;
        }

        .waze-hero-title {
            font-size: 24px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 4px;
        }

        .waze-hero-subtitle {
            font-size: 14px;
            color: #94a3b8;
        }

        .waze-info-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .waze-info-row:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px);
        }

        .waze-info-icon {
            width: 40px;
            height: 40px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .waze-info-content {
            flex: 1;
        }

        .waze-info-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .waze-info-value {
            font-size: 15px;
            color: #f8fafc;
            font-weight: 500;
        }

        .waze-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .waze-stat-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px 12px;
            text-align: center;
            transition: all 0.2s;
        }

        .waze-stat-box:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }

        .waze-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 4px;
            line-height: 1;
        }

        .waze-stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .waze-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .waze-badge.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .waze-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .waze-badge.info {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .waze-badge.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .waze-source {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
            padding: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .waze-source img {
            height: 24px;
        }

        .waze-source-text {
            flex: 1;
            font-size: 13px;
            color: #cbd5e1;
        }

        /* ===== RESPONSIVIDADE MOBILE - CONSERVADOR ===== */

        /* Corrigir grid em mobile */
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            .header-stats {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .linha-info {
                grid-template-columns: 1fr !important;
            }

            .bike-stats {
                flex-direction: column !important;
            }
        }

        @media (max-width: 480px) {
            .header-stats {
                grid-template-columns: 1fr !important;
            }

            .rota-stats {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>

<body>

    <!-- Normalizador de acentuaçío e logs (evita símbolos estranhos no DOM e console) -->
    <script>
        (function normalizeMobilidade() {
            const pairs = new Map([
                ['°', '°'], ['º', 'º'], ['ª', 'ª'],
                ['á', 'á'], ['í ', 'à'], ['í¢', 'â'], ['â', 'í'], ['í¤', 'ä'],
                ['é', 'é'], ['í¨', 'è'], ['ê', 'ê'], ['í«', 'ë'],
                ['í­', 'í'], ['í¬', 'ì'], ['í®', 'î'], ['í¯', 'ï'],
                ['í³', 'ó'], ['í²', 'ò'], ['í´', 'ô'], ['íµ', 'õ'], ['í¶', 'ö'],
                ['íº', 'ú'], ['í¹', 'ù'], ['í»', 'û'], ['í¼', 'ü'],
                ['ç', 'ç'], ['í±', 'ñ'],
                ['â€“', '–'], ['â€”', '—'], ['â€˜', '‘'], [''', '’'], ['"', '“'], ['"', '”'], ['â€¢', '•'], ['â€¦', '…']
            ]);
            function fix(s) { if (typeof s !== 'string') return s; let t = s; pairs.forEach((v, k) => { if (t.includes(k)) t = t.split(k).join(v); }); return t; }
            // Corrigir texto do DOM
            try {
                const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
                const nodes = []; while (walker.nextNode()) nodes.push(walker.currentNode);
                nodes.forEach(n => { const z = fix(n.nodeValue); if (z !== n.nodeValue) n.nodeValue = z; });
            } catch (e) { }
            // Corrigir logs do console
            ['log', 'info', 'warn', 'error'].forEach(m => { const o = console[m]; console[m] = function () { o.apply(console, Array.from(arguments).map(fix)); }; });
        })();
    </script>

    {% include 'includes/navbar_top.html' %}
    {% include 'includes/navbar_menu.html' %}



    <li class="cor-menu-item">
        <a href="#" class="cor-menu-link">
            Meteorologia
            <i class="bi bi-chevron-down dropdown-icon"></i>
        </a>
        <ul class="cor-submenu">
            <li class="cor-submenu-item">
                <a href="/meteorologia/" class="cor-submenu-link">
                    <i class="bi bi-cloud-sun"></i>
                    Dashboard
                </a>
            </li>
        </ul>
    </li>

    <li class="cor-menu-item">
        <a href="#" class="cor-menu-link">
            Defesa Civil
            <i class="bi bi-chevron-down dropdown-icon"></i>
        </a>
        <ul class="cor-submenu">
            <li class="cor-submenu-item">
                <a href="#" class="cor-submenu-link">
                    <i class="bi bi-megaphone"></i>
                    Sirenes
                </a>
            </li>
            <li class="cor-submenu-item">
                <a href="#" class="cor-submenu-link">
                    <i class="bi bi-exclamation-triangle"></i>
                    OcorrAªncias
                </a>
            </li>
        </ul>
    </li>

    </ul>
    </nav>

    <!-- CONTEAšDO PRINCIPAL -->
    <div class="dashboard-container">

        <!-- Header Padronizado -->
        <div class="dashboard-header">
            <div class="header-top">
                <div class="header-title">
                    <div class="header-icon">
                        <i class="bi bi-car-front-fill"></i>
                    </div>
                    <div>
                        <h1>Mobilidade Urbana</h1>
                        <p style="margin:0;color:#94a3b8;font-size:14px;">Sistema de transporte e Transito em tempo real
                        </p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Atualizar
                    </button>
                    <button class="header-btn" style="font-size: 12px; padding: 6px 12px;" onclick="toggleWazeLayer()">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span id="waze-toggle-text">Waze Alerts</span>
                    </button>
                    <button class="header-btn">
                        <i class="bi bi-download"></i>
                        Exportar
                    </button>
                </div>
            </div>

            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-value" id="brt-total">4</div>
                    <div class="header-stat-label">Linhas BRT</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="metro-total">3</div>
                    <div class="header-stat-label">Linhas MetrA´</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="bike-total">42</div>
                    <div class="header-stat-label">Bikes Disponiveis</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="transito-nivel">Normal</div>
                    <div class="header-stat-label">Status Transito</div>
                </div>
            </div>
        </div>

        <!-- Mapa de Mobilidade -->
        <div class="mob-section" style="padding: 0; overflow: hidden;">
            <div style="padding: 24px 24px 16px 24px;">
                <div class="mob-section-title">
                    <i class="bi bi-map-fill"></i>
                    Mapa de Mobilidade
                    <div style="margin-left: auto; display: flex; gap: 12px;">
                        <button class="header-btn" style="font-size: 12px; padding: 6px 12px;"
                            onclick="toggleKMLLayer()">
                            <i class="bi bi-bezier2"></i>
                            <span id="kml-toggle-text">Mostrar Rotas</span>
                        </button>
                        <button class="header-btn" style="font-size: 12px; padding: 6px 12px;" onclick="fitMapBounds()">
                            <i class="bi bi-arrows-fullscreen"></i>
                            Centralizar
                        </button>
                    </div>
                </div>
            </div>
            <div id="mobilidade-map" style="height: 500px; width: 100%; position: relative;">
                <!-- Botao de controle flutuante -->
                <button class="map-control-btn" id="map-control-btn" onclick="toggleControlPanel()"
                    title="Controle de Rotas">
                    <i class="bi bi-layers-fill"></i>
                    <div class="badge" id="rotas-badge">0</div>
                </button>

                <!-- âœ… ADICIONE ISTO: -->
                <!-- Indicador de modo de desenho -->
                <div class="desenho-mode-indicator" id="desenho-indicator">
                    <i class="bi bi-pencil-fill"></i>
                    <span>Clique em pontos-chave - A rota seguira as ruas automaticamente</span>
                </div>

                <!-- Controles de desenho -->
                <div class="desenho-controls" id="desenho-controls">
                    <button class="desenho-btn" onclick="finalizarDesenho()">
                        <i class="bi bi-check-circle-fill"></i>
                        Finalizar Rota
                    </button>
                    <button class="desenho-btn" onclick="desfazerPonto()">
                        <i class="bi bi-arrow-counterclockwise"></i>
                        Desfazer
                    </button>
                    <button class="desenho-btn cancel" onclick="cancelarDesenho()">
                        <i class="bi bi-x-circle-fill"></i>
                        Cancelar
                    </button>
                </div>

            </div>
        </div>

        <!-- Status do Transito -->
        <div class="mob-section">
            <div class="mob-section-title">
                <i class="bi bi-traffic-cone-fill"></i>
                Status do Transito
            </div>
            <div id="transito-container">
                <div class="loading">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Carregando status...</p>
                </div>
            </div>
        </div>

        <!-- BRT -->
        <div class="mob-section">
            <div class="mob-section-title">
                <i class="bi bi-bus-front-fill"></i>
                Linhas de BRT
            </div>
            <div class="cards-grid" id="brt-container">
                <div class="loading">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Carregando linhas...</p>
                </div>
            </div>
        </div>

        <!-- MetrA´ -->
        <div class="mob-section">
            <div class="mob-section-title">
                <i class="bi bi-train-front-fill"></i>
                Linhas de MetrA´
            </div>
            <div class="cards-grid" id="metro-container">
                <div class="loading">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Carregando linhas...</p>
                </div>
            </div>
        </div>

        <!-- Bike Rio -->
        <div class="mob-section">
            <div class="mob-section-title">
                <i class="bi bi-bicycle"></i>
                Bike Rio - EstacAµes
            </div>
            <div class="cards-grid" id="bike-container">
                <div class="loading">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Carregando estacAµes...</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Painel de Controle de Rotas -->
    <div class="rotas-control-panel minimized" id="rotas-control-panel">
        <div class="rotas-panel-header" onclick="toggleControlPanel()">
            <div class="rotas-panel-title">
                <i class="bi bi-layers-fill"></i>
                Controle de Rotas
            </div>
            <button class="rotas-panel-toggle" id="panel-toggle-btn">
                <i class="bi bi-chevron-left"></i>
            </button>
        </div>

        <!-- Alertas do Waze -->
        <div class="rotas-section">
            <div class="rotas-section-title">
                <i class="bi bi-exclamation-triangle-fill" style="color: #f59e0b;"></i>
                Alertas Waze
            </div>

            <div class="rotas-stats" style="grid-template-columns: repeat(2, 1fr);">
                <div class="rotas-stat-item">
                    <div class="rotas-stat-value" style="color: #ef4444;" id="waze-acidentes">0</div>
                    <div class="rotas-stat-label">Acidentes</div>
                </div>
                <div class="rotas-stat-item">
                    <div class="rotas-stat-value" style="color: #f59e0b;" id="waze-jams">0</div>
                    <div class="rotas-stat-label">Congestionamentos</div>
                </div>
            </div>

            <button class="rotas-action-btn" onclick="toggleWazeLayer()" style="margin-top: 12px;">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span id="waze-panel-text">Mostrar Alertas</span>
            </button>
        </div>

        <div class="rotas-panel-body">

            <!-- Estatísticas -->
            <div class="rotas-section">
                <div class="rotas-section-title">
                    <i class="bi bi-graph-up"></i>
                    Estatísticas
                </div>
                <div class="rotas-stats">
                    <div class="rotas-stat-item">
                        <div class="rotas-stat-value" id="total-rotas">0</div>
                        <div class="rotas-stat-label">Total de Rotas</div>
                    </div>
                    <div class="rotas-stat-item">
                        <div class="rotas-stat-value" id="rotas-visiveis">0</div>
                        <div class="rotas-stat-label">Visiveis</div>
                    </div>
                </div>
            </div>

            <!-- Filtros por Hierarquia -->
            <div class="rotas-section">
                <div class="rotas-section-title">
                    <i class="bi bi-funnel-fill"></i>
                    Filtrar por Hierarquia
                </div>

                <div class="rotas-filter" onclick="toggleHierarquia('Estrutural')">
                    <div class="rotas-filter-info">
                        <div class="rotas-filter-color" style="background: #ef4444;"></div>
                        <div>
                            <div class="rotas-filter-text">Estrutural</div>
                            <div class="rotas-filter-count" id="count-estrutural">0 rotas</div>
                        </div>
                    </div>
                    <div class="rotas-toggle-switch active" id="toggle-estrutural">
                        <div class="rotas-toggle-slider"></div>
                    </div>
                </div>

                <div class="rotas-filter" onclick="toggleHierarquia('Arterial primaria')">
                    <div class="rotas-filter-info">
                        <div class="rotas-filter-color" style="background: #f59e0b;"></div>
                        <div>
                            <div class="rotas-filter-text">Arterial Primaria</div>
                            <div class="rotas-filter-count" id="count-arterial-primaria">0 rotas</div>
                        </div>
                    </div>
                    <div class="rotas-toggle-switch active" id="toggle-arterial-primaria">
                        <div class="rotas-toggle-slider"></div>
                    </div>
                </div>

                <div class="rotas-filter" onclick="toggleHierarquia('Arterial secundaria')">
                    <div class="rotas-filter-info">
                        <div class="rotas-filter-color" style="background: #10b981;"></div>
                        <div>
                            <div class="rotas-filter-text">Arterial Secundaria</div>
                            <div class="rotas-filter-count" id="count-arterial-secundaria">0 rotas</div>
                        </div>
                    </div>
                    <div class="rotas-toggle-switch active" id="toggle-arterial-secundaria">
                        <div class="rotas-toggle-slider"></div>
                    </div>
                </div>

                <div class="rotas-filter" onclick="toggleHierarquia('Coletora')">
                    <div class="rotas-filter-info">
                        <div class="rotas-filter-color" style="background: #3b82f6;"></div>
                        <div>
                            <div class="rotas-filter-text">Coletora</div>
                            <div class="rotas-filter-count" id="count-coletora">0 rotas</div>
                        </div>
                    </div>
                    <div class="rotas-toggle-switch active" id="toggle-coletora">
                        <div class="rotas-toggle-slider"></div>
                    </div>
                </div>
            </div>

            <!-- AcAµes Rapidas -->
            <div class="rotas-section">
                <div class="rotas-section-title">
                    <i class="bi bi-lightning-fill"></i>
                    AcAµes Rapidas
                </div>

                <!-- âœ… ADICIONE ESTE BOTAƒO NOVO -->
                <button class="rotas-action-btn" onclick="iniciarDesenhoRota()"
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-color: #10b981;">
                    <i class="bi bi-plus-circle-fill"></i>
                    Adicionar Nova Rota
                </button>

                <button class="rotas-action-btn" onclick="mostrarTodasRotas()">
                    <i class="bi bi-eye-fill"></i>
                    Mostrar Todas
                </button>

                <button class="rotas-action-btn" onclick="ocultarTodasRotas()">
                    <i class="bi bi-eye-slash-fill"></i>
                    Ocultar Todas
                </button>

                <button class="rotas-action-btn" onclick="resetarCores()">
                    <i class="bi bi-palette-fill"></i>
                    Aplicar Cores
                </button>

                <button class="rotas-action-btn" onclick="centralizarTodasRotas()">
                    <i class="bi bi-bullseye"></i>
                    Centralizar Mapa
                </button>

                <!-- âœ… NOVOS BOTA•ES DE GERENCIAMENTO -->
                <button class="rotas-action-btn" onclick="exportarRotas()"
                    style="background: rgba(59, 130, 246, 0.2); border-color: #3b82f6;">
                    <i class="bi bi-download"></i>
                    Exportar Rotas
                </button>

                <button class="rotas-action-btn" onclick="limparRotasSalvas()"
                    style="background: rgba(239, 68, 68, 0.2); border-color: #ef4444;">
                    <i class="bi bi-trash-fill"></i>
                    Limpar Todas
                </button>
            </div>

            <!-- Legenda -->
            <div class="rotas-section">
                <div class="rotas-section-title">
                    <i class="bi bi-info-circle-fill"></i>
                    Legenda
                </div>
                <div class="rotas-legend">
                    <div class="rotas-legend-item">
                        <div class="rotas-legend-line" style="background: #ef4444;"></div>
                        <div class="rotas-legend-label">Estrutural</div>
                        <div class="rotas-legend-count" id="legend-estrutural">0</div>
                    </div>
                    <div class="rotas-legend-item">
                        <div class="rotas-legend-line" style="background: #f59e0b;"></div>
                        <div class="rotas-legend-label">Arterial Primaria</div>
                        <div class="rotas-legend-count" id="legend-arterial-primaria">0</div>
                    </div>
                    <div class="rotas-legend-item">
                        <div class="rotas-legend-line" style="background: #10b981;"></div>
                        <div class="rotas-legend-label">Arterial Secundaria</div>
                        <div class="rotas-legend-count" id="legend-arterial-secundaria">0</div>
                    </div>
                    <div class="rotas-legend-item">
                        <div class="rotas-legend-line" style="background: #3b82f6;"></div>
                        <div class="rotas-legend-label">Coletora</div>
                        <div class="rotas-legend-count" id="legend-coletora">0</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal de InformacAµes da Rota -->
    <div class="rota-modal" id="rota-modal">
        <div class="rota-modal-content">
            <div class="rota-modal-header">
                <div class="rota-modal-title">
                    <i class="bi bi-bezier2"></i>
                    <span id="rota-modal-title">InformacAµes da Rota</span>
                </div>
                <button class="rota-modal-close" onclick="closeRotaModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="rota-modal-body">
                <div class="rota-info-grid" id="rota-modal-body">
                    <!-- Conteudo sera inserido dinamicamente -->
                </div>
            </div>

            <div class="rota-modal-footer">
                <button class="rota-modal-btn rota-modal-btn-secondary" onclick="closeRotaModal()">
                    <i class="bi bi-x-circle"></i>
                    Fechar
                </button>
                <button class="rota-modal-btn rota-modal-btn-primary" onclick="centerRotaOnMap()">
                    <i class="bi bi-crosshair"></i>
                    Centralizar no Mapa
                </button>
            </div>
        </div>
    </div>
    <!-- Modal de Detalhes do Alerta Waze -->
    <div class="rota-modal" id="waze-modal">
        <div class="rota-modal-content">
            <div class="rota-modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <div class="rota-modal-title">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span id="waze-modal-title">Alerta Waze</span>
                </div>
                <button class="rota-modal-close" onclick="closeWazeModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="rota-modal-body">
                <div class="rota-info-grid" id="waze-modal-body">
                    <!-- Conteudo sera inserido dinamicamente -->
                </div>
            </div>

            <div class="rota-modal-footer">
                <button class="rota-modal-btn rota-modal-btn-secondary" onclick="closeWazeModal()">
                    <i class="bi bi-x-circle"></i>
                    Fechar
                </button>
                <button class="rota-modal-btn rota-modal-btn-primary"
                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" onclick="centerWazeOnMap()">
                    <i class="bi bi-crosshair"></i>
                    Centralizar no Mapa
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Alerta Waze -->
    <div class="rota-modal" id="waze-modal">
        <div class="rota-modal-content">
            <div class="rota-modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <div class="rota-modal-title">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span id="waze-modal-title">Alerta Waze</span>
                </div>
                <button class="rota-modal-close" onclick="closeWazeModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="rota-modal-body">
                <div class="rota-info-grid" id="waze-modal-body">
                    <!-- Conteudo sera inserido dinamicamente -->
                </div>
            </div>

            <div class="rota-modal-footer">
                <button class="rota-modal-btn rota-modal-btn-secondary" onclick="closeWazeModal()">
                    <i class="bi bi-x-circle"></i>
                    Fechar
                </button>
                <button class="rota-modal-btn rota-modal-btn-primary"
                    style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" onclick="centerWazeOnMap()">
                    <i class="bi bi-crosshair"></i>
                    Centralizar no Mapa
                </button>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <!-- Leaflet Omnivore (para KML) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"></script>

    <script>
        // ===== INICIALIZAR MAPA =====
        let mobilidadeMap;
        let kmlLayer;
        let kmlVisible = false;
        let selectedRotaLayer = null;
        let selectedWazeMarker = null;

        // âœ… ADICIONE ESTAS VARIAVEIS:
        // Sistema de desenho de rotas
        let desenhoModeAtivo = false;
        let pontosDesenho = [];
        let pontosChave = [];
        let modoInterativo = false;
        let linhaTemporaria = null;
        let marcadoresTemporarios = [];

        // âœ… VARIAVEIS DO WAZE
        let wazeLayer = null;
        let wazeMarkers = [];
        let wazeVisible = false;
        let wazeUpdateInterval = null;

        function initMapa() {
            mobilidadeMap = L.map('mobilidade-map', {
                center: [-22.9068, -43.1729],
                zoom: 11,
                zoomControl: true
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(mobilidadeMap);

            loadKMLLayer();
            // console.log('âœ… Mapa de mobilidade inicializado');
        }

        async function loadWazeAlerts() {
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸš— CARREGANDO ALERTAS DO WAZE...');
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            try {
                // console.log('ðŸ“¡ Fazendo requisicao para /api/waze/');

                const response = await fetch('/api/waze/');

                // console.log('âœ… Resposta recebida');
                // console.log('   Status:', response.status);
                // console.log('   OK:', response.ok);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // console.log('ðŸ“¦ Dados JSON parseados:');
                // console.log('   Tipo de data:', typeof data);
                // console.log('   data:', data);
                // console.log('   data.success:', data.success);
                // console.log('   data.alertas:', data.alertas);
                // console.log('   data.congestionamentos:', data.congestionamentos);

                // âœ… VERIFICAA‡AƒO ROBUSTA
                if (!data) {
                    throw new Error('Resposta vazia da API');
                }

                if (!data.success) {
                    throw new Error(data.error || 'API retornou success=false');
                }

                // âœ… GARANTIR QUE SEJAM ARRAYS
                const alertas = Array.isArray(data.alertas) ? data.alertas : [];
                const congestionamentos = Array.isArray(data.congestionamentos) ? data.congestionamentos : [];

                // console.log('ðŸ“Š Arrays verificados:');
                // console.log('   Alertas:', alertas.length);
                // console.log('   Congestionamentos:', congestionamentos.length);

                // âœ… COMBINAR COM SEGURANA‡A
                const todosAlertas = [...alertas, ...congestionamentos];

                // console.log('âœ… Total combinado:', todosAlertas.length);

                if (todosAlertas.length === 0) {
                    console.warn('âš ï¸ Nenhum alerta disponivel');
                    alert('â„¹ï¸ Nenhum alerta do Waze disponivel no momento.');
                    return;
                }

                // Limpar marcadores antigos
                // console.log('ðŸ—‘ï¸ Limpando', wazeMarkers.length, 'marcadores antigos');

                wazeMarkers.forEach(marker => {
                    try {
                        if (marker && mobilidadeMap.hasLayer(marker)) {
                            mobilidadeMap.removeLayer(marker);
                        }
                    } catch (e) {
                        console.warn('Erro ao remover marcador:', e);
                    }
                });
                wazeMarkers = [];

                // console.log('âœ… Marcadores limpos');

                let marcadoresAdicionados = 0;
                let marcadoresComErro = 0;

                // Processar alertas
                todosAlertas.forEach((alert, index) => {
                    try {
                        console.log(`ðŸ” [${index + 1}/${todosAlertas.length}] Processando:`, alert);

                        const marker = criarMarcadorWaze(alert);

                        if (marker) {
                            if (wazeVisible) {
                                marker.addTo(mobilidadeMap);
                                marcadoresAdicionados++;
                                // console.log('   âœ… Marcador adicionado ao mapa');
                            }
                            wazeMarkers.push(marker);
                        } else {
                            marcadoresComErro++;
                            console.warn('   ⚠ Marcador não criado (sem coordenadas?)');
                        }
                    } catch (err) {
                        marcadoresComErro++;
                        console.error('   âŒ Erro ao processar alerta:', err);
                    }
                });

                // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                // console.log('ðŸ“Š RESUMO:');
                // console.log('   Total de alertas:', todosAlertas.length);
                // console.log('   Marcadores criados:', wazeMarkers.length);
                // console.log('   Marcadores visiveis:', marcadoresAdicionados);
                // console.log('   Com erro:', marcadoresComErro);
                // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                atualizarEstatisticasWaze(todosAlertas);

                alert('Waze carregado com sucesso!');

            } catch (error) {
                /* console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ ERRO FATAL:');
                console.error('   Mensagem:', error.message);
                console.error('   Stack:', error.stack);
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
 */
                alert('âŒ Erro ao carregar Waze:\n\n' + error.message + '\n\nVeja o console (F12) para detalhes.');
            }
        }

        function abrirModalNovaRota() {
            // console.log('ðŸ“‹ Abrindo modal...');

            // Garantir modo automatico ativo
            modoAtual = 'automatico';
            document.getElementById('tab-automatico').classList.add('active');
            document.getElementById('tab-manual').classList.remove('active');

            const modoAuto = document.getElementById('modo-automatico');
            const modoManual = document.getElementById('modo-manual');

            modoAuto.classList.add('active');
            modoAuto.style.display = 'block';

            modoManual.classList.remove('active');
            modoManual.style.display = 'none';

            // Abrir modal
            const modal = document.getElementById('nova-rota-modal');
            modal.classList.add('active');

            // console.log('âœ… Modal aberto');
        }

        function criarMarcadorWaze(alert) {
            const lat = alert.lat || alert.location?.y;
            const lng = alert.lng || alert.location?.x;

            if (!lat || !lng) {
                return null;
            }

            // ✅ VERIFICAR TIPO E SUBTIPO
            const tipo = (alert.tipo || alert.type || '').toUpperCase();
            const subtipo = (alert.subtipo || alert.subtype || '').toUpperCase();

            // ✅ MAPEAMENTO COMPLETO COM BOOTSTRAP ICONS
            const mapa = {
                // PERIGOS
                'PERIGO': { icon: 'bi-exclamation-diamond-fill', color: '#eab308', titulo: 'Perigo' },
                'BURACO': { icon: 'bi-sign-stop-fill', color: '#ef4444', titulo: 'Buraco' },
                'CLIMA': { icon: 'bi-cloud-rain-fill', color: '#6366f1', titulo: 'Condiçío Climática' },
                'PERIGO NA PISTA': { icon: 'bi-exclamation-octagon-fill', color: '#f59e0b', titulo: 'Perigo na Pista' },
                'HAZARD_ON_SHOULDER_CAR_STOPPED': { icon: 'bi-car-front-fill', color: '#f59e0b', titulo: 'Veículo Parado' },
                'HAZARD': { icon: 'bi-exclamation-triangle-fill', color: '#f59e0b', titulo: 'Perigo' },

                // VIA FECHADA
                'VIA FECHADA': { icon: 'bi-slash-circle-fill', color: '#dc2626', titulo: 'Via Fechada' },
                'ROAD_CLOSED': { icon: 'bi-slash-circle-fill', color: '#dc2626', titulo: 'Via Fechada' },

                // CONGESTIONAMENTOS
                'CONGESTIONAMENTO': { icon: 'bi-exclamation-triangle-fill', color: '#f97316', titulo: 'Congestionamento' },
                'JAM': { icon: 'bi-truck-front', color: '#f97316', titulo: 'Congestionamento' },
                'JAM_HEAVY_TRAFFIC': { icon: 'bi-truck-front', color: '#f97316', titulo: 'Trânsito Pesado' },
                'JAM_STAND_STILL_TRAFFIC': { icon: 'bi-exclamation-circle-fill', color: '#dc2626', titulo: 'Trânsito Parado' },

                // ACIDENTES
                'ACIDENTE': { icon: 'bi-car-front-fill', color: '#dc2626', titulo: 'Acidente' },
                'ACCIDENT': { icon: 'bi-car-front-fill', color: '#dc2626', titulo: 'Acidente' },

                // OBRAS
                'OBRA': { icon: 'bi-cone-striped', color: '#f59e0b', titulo: 'Obra' },
                'CONSTRUCTION': { icon: 'bi-cone-striped', color: '#f59e0b', titulo: 'Obra' }
            };

            // ? BUSCAR: subtipo > tipo > padrío
            const cfg = mapa[subtipo] || mapa[tipo] || {
                icon: 'bi-question-circle-fill',
                color: '#94a3b8',
                titulo: 'Alerta'
            };

            // ✅ CRIAR MARCADOR COM BOOTSTRAP ICON
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'waze-marker-static',
                    html: `
                <div style="
                    width: 36px;
                    height: 36px;
                    background: ${cfg.color};
                    border: 3px solid white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.4);
                    cursor: pointer;
                ">
                    <i class="bi ${cfg.icon}" style="color: white; font-size: 18px;"></i>
                </div>
            `,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                })
            });

            // ✅ ARMAZENAR DADOS
            marker.wazeData = {
                ...alert,
                icone: `<i class="bi ${cfg.icon}"></i>`,
                cor: cfg.color,
                titulo: cfg.titulo
            };

            // ✅ EVENTO DE CLIQUE
            marker.on('click', function (e) {
                L.DomEvent.stopPropagation(e);
                showWazeModal(marker);
            });

            return marker;
        }

        function atualizarEstatisticasWaze(alerts) {
            const stats = {
                acidentes: 0,
                congestionamentos: 0
            };

            alerts.forEach(alert => {
                const tipo = alert.tipo || alert.type || '';

                if (tipo.includes('Acidente') || tipo === 'ACCIDENT') {
                    stats.acidentes++;
                } else if (tipo.includes('Congestionamento') || tipo === 'JAM') {
                    stats.congestionamentos++;
                }
            });

            const elemAcidentes = document.getElementById('waze-acidentes');
            const elemJams = document.getElementById('waze-jams');

            if (elemAcidentes) elemAcidentes.textContent = stats.acidentes;
            if (elemJams) elemJams.textContent = stats.congestionamentos;

            // console.log('ðŸ“Š Waze:', stats.acidentes, 'acidentes |', stats.congestionamentos, 'congestionamentos');
        }

        function toggleWazeLayer() {
            wazeVisible = !wazeVisible;

            const toggleText = document.getElementById('waze-toggle-text');
            const panelText = document.getElementById('waze-panel-text');

            if (wazeVisible) {
                // Carregar e mostrar alertas
                loadWazeAlerts();

                // Iniciar atualizacao automatica
                wazeUpdateInterval = setInterval(loadWazeAlerts, 2 * 60 * 1000);

                if (toggleText) toggleText.textContent = 'Ocultar Waze';
                if (panelText) panelText.textContent = 'Ocultar Alertas';

                // console.log('âœ… Alertas do Waze ativados');
            } else {
                // Ocultar marcadores
                wazeMarkers.forEach(marker => {
                    if (marker) mobilidadeMap.removeLayer(marker);
                });

                // Parar atualizacao
                if (wazeUpdateInterval) {
                    clearInterval(wazeUpdateInterval);
                    wazeUpdateInterval = null;
                }

                if (toggleText) toggleText.textContent = 'Waze Alerts';
                if (panelText) panelText.textContent = 'Mostrar Alertas';

                // console.log('ðŸ”´ Alertas do Waze ocultos');
            }
        }

        function loadKMLLayer() {
            try {
                kmlLayer = omnivore.kml('{% static "mobilidade/kml/rotas.kml" %}')
                    .on('ready', function () {
                        // console.log('âœ… KML carregado com sucesso');

                        let rotasClicaveis = [];

                        kmlLayer.eachLayer(function (layer) {
                            if (layer instanceof L.Polyline) {
                                layer.setStyle({
                                    color: '#f59e0b',
                                    weight: 3,
                                    opacity: 0.7,
                                    interactive: true
                                });

                                rotasClicaveis.push(layer);

                                layer.on('click', function (e) {
                                    L.DomEvent.stopPropagation(e);
                                    showRotaModal(layer);
                                });

                                layer.on('mouseover', function (e) {
                                    this.setStyle({
                                        color: '#fbbf24',
                                        weight: 5,
                                        opacity: 1
                                    });
                                });

                                layer.on('mouseout', function (e) {
                                    if (selectedRotaLayer !== this) {
                                        const hierarquia = this._hierarquia || 'Sem classificacao';
                                        const cor = hierarquiaCores[hierarquia] || '#f59e0b';
                                        this.setStyle({
                                            color: cor,
                                            weight: hierarquia === 'Estrutural' ? 4 : 3,
                                            opacity: 0.8
                                        });
                                    }
                                });
                            }
                        });

                        // console.log('ðŸ“Š Total de rotas carregadas:', rotasClicaveis.length);
                        window.rotasClicaveis = rotasClicaveis;

                        // Aplicar cores automaticamente
                        aplicarCoresPorHierarquia();
                    })
                    .on('error', function (e) {
                        console.error('âŒ Erro ao carregar KML:', e);
                        alert('Erro ao carregar rotas. Verifique se o arquivo KML existe.');
                    });

            } catch (error) {
                console.error('âŒ Erro ao processar KML:', error);
            }
        }

        function toggleKMLLayer() {
            if (!kmlLayer) {
                alert('Camada KML ainda nao foi carregada');
                return;
            }

            const toggleText = document.getElementById('kml-toggle-text');
            const panel = document.getElementById('rotas-control-panel');
            const btn = document.getElementById('map-control-btn');

            if (kmlVisible) {
                // OCULTAR APENAS ROTAS (NAƒO WAZE)
                mobilidadeMap.removeLayer(kmlLayer);
                kmlVisible = false;
                toggleText.textContent = 'Mostrar Rotas';

                // Ocultar painel e botao
                panel.classList.add('minimized');
                btn.classList.remove('visible');

                // console.log('ðŸ”´ Rotas ocultadas');
                // console.log('ðŸ’¡ Waze continua visivel (se estava ativo)');
            } else {
                // MOSTRAR ROTAS
                kmlLayer.addTo(mobilidadeMap);
                kmlVisible = true;
                toggleText.textContent = 'Ocultar Rotas';

                // Mostrar painel e botao
                panel.classList.remove('minimized');
                btn.classList.add('visible');

                // console.log('âœ… Rotas exibidas');

                try {
                    mobilidadeMap.fitBounds(kmlLayer.getBounds());
                } catch (e) {
                    // console.log('Nao foi possivel ajustar bounds');
                }
            }
        }

        function toggleControlPanel() {
            const panel = document.getElementById('rotas-control-panel');
            const btn = document.getElementById('panel-toggle-btn');

            panel.classList.toggle('minimized');

            if (panel.classList.contains('minimized')) {
                btn.innerHTML = '<i class="bi bi-chevron-left"></i>';
                // console.log('ðŸ“¦ Painel minimizado');
            } else {
                btn.innerHTML = '<i class="bi bi-chevron-right"></i>';
                // console.log('ðŸ“‹ Painel expandido');
            }
        }

        function fitMapBounds() {
            if (kmlLayer && kmlVisible) {
                try {
                    mobilidadeMap.fitBounds(kmlLayer.getBounds());
                } catch (e) {
                    mobilidadeMap.setView([-22.9068, -43.1729], 11);
                }
            } else {
                mobilidadeMap.setView([-22.9068, -43.1729], 11);
            }
        }

        // ===== SISTEMA DE CORES POR HIERARQUIA =====
        const hierarquiaCores = {
            'Estrutural': '#ef4444',
            'Arterial primaria': '#f59e0b',
            'Arterial secundaria': '#10b981',
            'Coletora': '#3b82f6',
            'Sem classificacao': '#64748b'
        };

        const filtrosAtivos = {
            'Estrutural': true,
            'Arterial primaria': true,
            'Arterial secundaria': true,
            'Coletora': true
        };

        function aplicarCoresPorHierarquia() {
            if (!window.rotasClicaveis) return;

            window.rotasClicaveis.forEach(rota => {
                const hierarquia = rota.feature.properties.Hierarquia ||
                    rota.feature.properties.hierarquia ||
                    'Sem classificacao';

                const cor = hierarquiaCores[hierarquia] || '#64748b';

                rota.setStyle({
                    color: cor,
                    weight: hierarquia === 'Estrutural' ? 4 : 3,
                    opacity: 0.8
                });

                rota._hierarquia = hierarquia;
            });

            // console.log('âœ… Cores aplicadas por hierarquia');
            atualizarEstatisticas();
        }

        function atualizarEstatisticas() {
            if (!window.rotasClicaveis) return;

            const contadores = {};
            let visiveis = 0;

            window.rotasClicaveis.forEach(rota => {
                const hierarquia = rota._hierarquia || 'Sem classificacao';
                contadores[hierarquia] = (contadores[hierarquia] || 0) + 1;

                if (mobilidadeMap.hasLayer(rota)) {
                    visiveis++;
                }
            });

            document.getElementById('total-rotas').textContent = window.rotasClicaveis.length;
            document.getElementById('rotas-visiveis').textContent = visiveis;

            document.getElementById('count-estrutural').textContent = (contadores['Estrutural'] || 0) + ' rotas';
            document.getElementById('count-arterial-primaria').textContent = (contadores['Arterial primaria'] || 0) + ' rotas';
            document.getElementById('count-arterial-secundaria').textContent = (contadores['Arterial secundaria'] || 0) + ' rotas';
            document.getElementById('count-coletora').textContent = (contadores['Coletora'] || 0) + ' rotas';

            document.getElementById('legend-estrutural').textContent = contadores['Estrutural'] || 0;
            document.getElementById('legend-arterial-primaria').textContent = contadores['Arterial primaria'] || 0;
            document.getElementById('legend-arterial-secundaria').textContent = contadores['Arterial secundaria'] || 0;
            document.getElementById('legend-coletora').textContent = contadores['Coletora'] || 0;

            document.getElementById('rotas-badge').textContent = visiveis;
        }

        function toggleHierarquia(hierarquia) {
            filtrosAtivos[hierarquia] = !filtrosAtivos[hierarquia];

            const toggleId = 'toggle-' + hierarquia.toLowerCase().replace(' ', '-');
            const toggleElement = document.getElementById(toggleId);

            if (filtrosAtivos[hierarquia]) {
                toggleElement.classList.add('active');
            } else {
                toggleElement.classList.remove('active');
            }

            window.rotasClicaveis.forEach(rota => {
                if (rota._hierarquia === hierarquia) {
                    if (filtrosAtivos[hierarquia]) {
                        rota.addTo(mobilidadeMap);
                    } else {
                        mobilidadeMap.removeLayer(rota);
                    }
                }
            });

            atualizarEstatisticas();
        }

        function mostrarTodasRotas() {
            Object.keys(filtrosAtivos).forEach(h => filtrosAtivos[h] = true);

            window.rotasClicaveis.forEach(rota => {
                rota.addTo(mobilidadeMap);
            });

            ['estrutural', 'arterial-primaria', 'arterial-secundaria', 'coletora'].forEach(id => {
                document.getElementById('toggle-' + id).classList.add('active');
            });

            atualizarEstatisticas();
            // console.log('âœ… Todas as rotas visiveis');
        }

        function ocultarTodasRotas() {
            Object.keys(filtrosAtivos).forEach(h => filtrosAtivos[h] = false);

            window.rotasClicaveis.forEach(rota => {
                mobilidadeMap.removeLayer(rota);
            });

            ['estrutural', 'arterial-primaria', 'arterial-secundaria', 'coletora'].forEach(id => {
                document.getElementById('toggle-' + id).classList.remove('active');
            });

            atualizarEstatisticas();
            // console.log('ðŸ”´ Todas as rotas ocultas');
        }

        function resetarCores() {
            aplicarCoresPorHierarquia();
        }

        function centralizarTodasRotas() {
            if (kmlLayer) {
                try {
                    mobilidadeMap.fitBounds(kmlLayer.getBounds());
                } catch (e) {
                    mobilidadeMap.setView([-22.9068, -43.1729], 11);
                }
            }
        }

        function redesenharMarcadores() {
            // console.log('ðŸ”„ Redesenhando marcadores...');

            // Limpar todos os marcadores antigos
            marcadoresTemporarios.forEach(m => {
                try {
                    if (m && mobilidadeMap.hasLayer(m)) {
                        // Remover todos os eventos antes
                        if (m.off) {
                            m.off();
                        }
                        mobilidadeMap.removeLayer(m);
                    }
                } catch (e) {
                    console.warn('Erro ao remover marcador:', e);
                }
            });
            marcadoresTemporarios = [];

            // Criar novos marcadores para cada ponto
            pontosChave.forEach((ponto, index) => {
                // Validacao rigorosa
                if (!ponto ||
                    typeof ponto.lat !== 'number' ||
                    typeof ponto.lng !== 'number' ||
                    isNaN(ponto.lat) ||
                    isNaN(ponto.lng)) {
                    console.warn('Ponto invalido no indice', index);
                    return;
                }

                try {
                    // Circulo visual
                    const circleMarker = L.circleMarker([ponto.lat, ponto.lng], {
                        radius: 8,
                        color: '#ffffff',
                        fillColor: '#ef4444',
                        fillOpacity: 1,
                        weight: 3
                    }).addTo(mobilidadeMap);

                    // Marcador arrastavel com numero
                    const numeroDiv = L.divIcon({
                        className: 'ponto-numero',
                        html: `<div style="
                    background: #ef4444;
                    color: white;
                    width: 28px;
                    height: 28px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 14px;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                    cursor: move;
                ">${index + 1}</div>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });

                    const numeroMarker = L.marker([ponto.lat, ponto.lng], {
                        icon: numeroDiv,
                        draggable: true
                    }).addTo(mobilidadeMap);

                    // Armazenar referAªncia ao indice
                    numeroMarker._pontoIndex = index;
                    numeroMarker._circleMarker = circleMarker;

                    // ===== EVENTO DE ARRASTAR =====
                    numeroMarker.on('drag', function (e) {
                        const newLatLng = e.target.getLatLng();
                        const idx = numeroMarker._pontoIndex;

                        if (idx >= 0 && idx < pontosChave.length) {
                            pontosChave[idx] = {
                                lat: newLatLng.lat,
                                lng: newLatLng.lng
                            };

                            // Atualizar circulo visual
                            if (numeroMarker._circleMarker) {
                                numeroMarker._circleMarker.setLatLng(newLatLng);
                            }
                        }
                    });

                    // ===== EVENTO DRAGEND (RECALCULAR) =====
                    numeroMarker.on('dragend', async function (e) {
                        // console.log('ðŸŽ¯ Ponto arrastado - recalculando...');
                        await recalcularRota();
                    });

                    // ===== DUPLO-CLIQUE PARA REMOVER =====
                    numeroMarker.on('dblclick', function (e) {
                        L.DomEvent.stopPropagation(e);

                        const idx = numeroMarker._pontoIndex;

                        if (confirm(`Remover ponto ${idx + 1}?`)) {
                            // console.log('ðŸ—‘ï¸ Removendo ponto', idx + 1);

                            // Remover do array
                            pontosChave.splice(idx, 1);

                            // console.log('âœ… Ponto removido. Restam:', pontosChave.length);

                            // Redesenhar tudo
                            redesenharMarcadores();

                            // Recalcular rota
                            if (pontosChave.length >= 2) {
                                recalcularRota();
                            } else if (pontosChave.length < 2) {
                                // Remover linha
                                if (linhaTemporaria) {
                                    mobilidadeMap.removeLayer(linhaTemporaria);
                                    linhaTemporaria = null;
                                }
                                pontosDesenho = [];
                            }
                        }
                    });

                    marcadoresTemporarios.push(circleMarker, numeroMarker);

                } catch (err) {
                    console.error('âŒ Erro ao criar marcador', index, ':', err);
                }
            });

            // console.log('âœ…', pontosChave.length, 'marcadores redesenhados');
        }

        // ===== ANALISE DE TRA‚NSITO EM ROTAS =====

        function analisarTransitoNaRota(layer) {
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ” ANALISANDO TRA‚NSITO NA ROTA');
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            // console.log('wazeMarkers existe?', !!wazeMarkers);
            // console.log('wazeMarkers.length:', wazeMarkers ? wazeMarkers.length : 0);
            // console.log('wazeVisible:', wazeVisible);

            if (!wazeMarkers || wazeMarkers.length === 0) {
                // console.log('âŒ Nenhum dado do Waze carregado');
                return null;
            }

            const latlngs = layer.getLatLngs();
            // console.log('Pontos da rota:', latlngs.length);

            if (!latlngs || latlngs.length === 0) {
                // console.log('âŒ Rota sem pontos');
                return null;
            }

            // Estatísticas
            const analise = {
                acidentes: 0,
                congestionamentos: 0,
                perigos: 0,
                outros: 0,
                velocidades: [],
                velocidadeMedia: null,
                nivelCongestionamento: 0,
                alertasProximos: [],
                distanciaTotal: 0
            };

            // Calcular distA¢ncia total da rota
            for (let i = 0; i < latlngs.length - 1; i++) {
                analise.distanciaTotal += mobilidadeMap.distance(latlngs[i], latlngs[i + 1]);
            }
            analise.distanciaTotal = (analise.distanciaTotal / 1000).toFixed(2);

            // console.log('ðŸ“ DistA¢ncia total da rota:', analise.distanciaTotal, 'km');

            // Raio de busca (200 metros)
            const raioMetros = 200;
            // console.log('ðŸŽ¯ Raio de busca:', raioMetros, 'metros');

            let marcadoresVerificados = 0;
            let marcadoresProximos = 0;

            // Verificar cada marcador do Waze
            wazeMarkers.forEach((marker, index) => {
                if (!marker || !marker.wazeData) {
                    console.log(`âš ï¸ Marcador ${index} sem dados`);
                    return;
                }

                marcadoresVerificados++;

                const markerLatLng = marker.getLatLng();
                let menorDistancia = Infinity;

                // Calcular distA¢ncia minima do marcador ate a rota
                latlngs.forEach(ponto => {
                    const distancia = mobilidadeMap.distance(markerLatLng, ponto);
                    if (distancia < menorDistancia) {
                        menorDistancia = distancia;
                    }
                });

                // Se estiver proximo
                if (menorDistancia <= raioMetros) {
                    marcadoresProximos++;

                    const data = marker.wazeData;
                    const tipo = data.tipo || data.type || '';

                    console.log(`âœ… [${marcadoresProximos}] Alerta proximo:`, tipo, `(${Math.round(menorDistancia)}m)`);

                    // Contar por tipo
                    if (tipo.includes('Acidente') || tipo === 'ACCIDENT') {
                        analise.acidentes++;
                    } else if (tipo.includes('Congestionamento') || tipo === 'JAM') {
                        analise.congestionamentos++;

                        if (data.velocidade !== undefined) {
                            analise.velocidades.push(data.velocidade);
                            // console.log('  ðŸ“Š Velocidade:', data.velocidade, 'km/h');
                        }

                        if (data.nivel !== undefined) {
                            analise.nivelCongestionamento += data.nivel;
                            // console.log('  ðŸš¦ Nivel:', data.nivel);
                        }
                    } else if (tipo.includes('Perigo') || tipo === 'HAZARD' || tipo === 'WEATHERHAZARD' || tipo === 'ROAD_CLOSED') {
                        analise.perigos++;
                    } else {
                        analise.outros++;
                    }

                    // Guardar alerta
                    analise.alertasProximos.push({
                        tipo: data.titulo,
                        icone: data.icone,
                        cor: data.cor,
                        rua: data.rua || data.street || 'Via nao identificada',
                        distancia: Math.round(menorDistancia)
                    });
                }
            });

            // console.log('ðŸ“Š Marcadores verificados:', marcadoresVerificados);
            // console.log('ðŸ“ Marcadores proximos:', marcadoresProximos);

            // Calcular velocidade media
            if (analise.velocidades.length > 0) {
                const soma = analise.velocidades.reduce((a, b) => a + b, 0);
                analise.velocidadeMedia = Math.round((soma / analise.velocidades.length) * 10) / 10;
                // console.log('ðŸš— Velocidade media:', analise.velocidadeMedia, 'km/h');
            }

            // Calcular nivel medio
            if (analise.congestionamentos > 0) {
                analise.nivelCongestionamento = Math.round(analise.nivelCongestionamento / analise.congestionamentos);
            }

            analise.totalAlertas = analise.acidentes + analise.congestionamentos + analise.perigos + analise.outros;

            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ“Š RESUMO DA ANALISE:');
            // console.log('   Total de alertas:', analise.totalAlertas);
            // console.log('   ðŸš¨ Acidentes:', analise.acidentes);
            // console.log('   ðŸš— Congestionamentos:', analise.congestionamentos);
            // console.log('   âš ï¸ Perigos:', analise.perigos);
            // console.log('   ðŸ“ Outros:', analise.outros);
            // console.log('   ðŸš™ Velocidade media:', analise.velocidadeMedia);
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            return analise;
        }

        function getStatusTransito(analise) {
            if (!analise || analise.totalAlertas === 0) {
                return {
                    nivel: 0,
                    texto: 'Sem InformacAµes',
                    cor: '#64748b',
                    icone: 'â“',
                    badge: 'info'
                };
            }

            // Baseado em velocidade media
            if (analise.velocidadeMedia !== null) {
                if (analise.velocidadeMedia < 10) {
                    return {
                        nivel: 4,
                        texto: 'Transito Parado',
                        cor: '#dc2626',
                        icone: 'ðŸš«',
                        badge: 'danger'
                    };
                } else if (analise.velocidadeMedia < 20) {
                    return {
                        nivel: 3,
                        texto: 'Transito Intenso',
                        cor: '#ef4444',
                        icone: 'ðŸš—',
                        badge: 'danger'
                    };
                } else if (analise.velocidadeMedia < 40) {
                    return {
                        nivel: 2,
                        texto: 'Transito Moderado',
                        cor: '#f59e0b',
                        icone: 'ðŸš™',
                        badge: 'warning'
                    };
                } else {
                    return {
                        nivel: 1,
                        texto: 'Transito Fluindo',
                        cor: '#10b981',
                        icone: 'âœ…',
                        badge: 'success'
                    };
                }
            }

            // Baseado em congestionamentos
            if (analise.congestionamentos >= 3) {
                return {
                    nivel: 3,
                    texto: 'Transito Intenso',
                    cor: '#ef4444',
                    icone: 'ðŸš—',
                    badge: 'danger'
                };
            } else if (analise.congestionamentos >= 1) {
                return {
                    nivel: 2,
                    texto: 'Transito Moderado',
                    cor: '#f59e0b',
                    icone: 'ðŸš™',
                    badge: 'warning'
                };
            }

            // Baseado em acidentes
            if (analise.acidentes >= 1) {
                return {
                    nivel: 3,
                    texto: 'Atencao - Acidente',
                    cor: '#ef4444',
                    icone: 'ðŸš¨',
                    badge: 'danger'
                };
            }

            return {
                nivel: 1,
                texto: 'Transito Normal',
                cor: '#10b981',
                icone: 'âœ…',
                badge: 'success'
            };
        }

        function getStatusTransito(analise) {
            if (!analise || analise.totalAlertas === 0) {
                return {
                    nivel: 0,
                    texto: 'Sem InformacAµes',
                    cor: '#64748b',
                    icone: 'â“',
                    badge: 'info'
                };
            }

            // Baseado em velocidade media
            if (analise.velocidadeMedia !== null) {
                if (analise.velocidadeMedia < 10) {
                    return {
                        nivel: 4,
                        texto: 'Transito Parado',
                        cor: '#dc2626',
                        icone: 'ðŸš«',
                        badge: 'danger'
                    };
                } else if (analise.velocidadeMedia < 20) {
                    return {
                        nivel: 3,
                        texto: 'Transito Intenso',
                        cor: '#ef4444',
                        icone: 'ðŸš—',
                        badge: 'danger'
                    };
                } else if (analise.velocidadeMedia < 40) {
                    return {
                        nivel: 2,
                        texto: 'Transito Moderado',
                        cor: '#f59e0b',
                        icone: 'ðŸš™',
                        badge: 'warning'
                    };
                } else {
                    return {
                        nivel: 1,
                        texto: 'Transito Fluindo',
                        cor: '#10b981',
                        icone: 'âœ…',
                        badge: 'success'
                    };
                }
            }

            // Baseado em numero de congestionamentos
            if (analise.congestionamentos >= 3) {
                return {
                    nivel: 3,
                    texto: 'Transito Intenso',
                    cor: '#ef4444',
                    icone: 'ðŸš—',
                    badge: 'danger'
                };
            } else if (analise.congestionamentos >= 1) {
                return {
                    nivel: 2,
                    texto: 'Transito Moderado',
                    cor: '#f59e0b',
                    icone: 'ðŸš™',
                    badge: 'warning'
                };
            }

            // Baseado em acidentes
            if (analise.acidentes >= 1) {
                return {
                    nivel: 3,
                    texto: 'Atencao - Acidente',
                    cor: '#ef4444',
                    icone: 'ðŸš¨',
                    badge: 'danger'
                };
            }

            // Padrao: OK
            return {
                nivel: 1,
                texto: 'Transito Normal',
                cor: '#10b981',
                icone: 'âœ…',
                badge: 'success'
            };
        }

        function showRotaModal(layer) {

            // ===== DEBUG =====
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ“‹ ABRINDO MODAL DA ROTA');
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('Layer:', layer);
            // console.log('Layer type:', layer instanceof L.Polyline);
            // console.log('LatLngs:', layer.getLatLngs ? layer.getLatLngs() : 'N/A');
            selectedRotaLayer = layer;

            layer.setStyle({
                color: '#fbbf24',
                weight: 5,
                opacity: 1
            });

            const properties = layer.feature.properties || {};
            const nome = properties.name || 'Rota sem identificacao';
            const trecho = properties.Trecho || properties.trecho || '';
            const hierarquia = properties.Hierarquia || properties.hierarquia || '';

            let distance = 0;
            const latlngs = layer.getLatLngs();
            if (latlngs && latlngs.length > 1) {
                for (let i = 0; i < latlngs.length - 1; i++) {
                    distance += latlngs[i].distanceTo(latlngs[i + 1]);
                }
            }
            distance = (distance / 1000).toFixed(2);

            const hierarquiaCoresModal = {
                'Estrutural': { cor: '#ef4444', icon: 'bi-lightning-charge-fill' },
                'Arterial primaria': { cor: '#f59e0b', icon: 'bi-diagram-3-fill' },
                'Arterial secundaria': { cor: '#10b981', icon: 'bi-diagram-2-fill' },
                'Coletora': { cor: '#3b82f6', icon: 'bi-signpost-split-fill' }
            };

            const hierarquiaInfo = hierarquiaCoresModal[hierarquia] || { cor: '#64748b', icon: 'bi-question-circle-fill' };

            document.getElementById('rota-modal-title').textContent = nome;

            let content = `
                <div class="rota-info-item">
                    <div class="rota-info-label">
                        <i class="bi bi-signpost-2-fill"></i>
                        Nome da Via
                    </div>
                    <div class="rota-info-value" style="font-size: 18px; font-weight: 600;">${nome}</div>
                </div>
            `;

            if (hierarquia) {
                content += `
                    <div class="rota-info-item" style="border-left: 4px solid ${hierarquiaInfo.cor};">
                        <div class="rota-info-label">
                            <i class="${hierarquiaInfo.icon}" style="color: ${hierarquiaInfo.cor};"></i>
                            Classificacao Viaria
                        </div>
                        <div class="rota-info-value" style="color: ${hierarquiaInfo.cor}; font-weight: 600;">
                            ${hierarquia}
                        </div>
                    </div>
                `;
            }

            if (trecho && trecho.trim() !== '') {
                content += `
                    <div class="rota-info-item">
                        <div class="rota-info-label">
                            <i class="bi bi-geo-alt-fill"></i>
                            Trecho
                        </div>
                        <div class="rota-info-value">${trecho}</div>
                    </div>
                `;
            }

            content += `
                <div class="rota-stats">
                    <div class="rota-stat-card">
                        <div class="rota-stat-value">${distance}</div>
                        <div class="rota-stat-label">Km de Extensao</div>
                    </div>
                    <div class="rota-stat-card">
                        <div class="rota-stat-value">${latlngs.length}</div>
                        <div class="rota-stat-label">Pontos no Tracado</div>
                    </div>
                </div>
            `;

            // ===== ðŸš— ANALISE DE TRA‚NSITO WAZE =====
            const analise = analisarTransitoNaRota(layer);

            if (analise && analise.totalAlertas > 0) {
                const status = getStatusTransito(analise);

                content += `
                    <div class="rota-info-item" style="background: linear-gradient(135deg, ${status.cor}20 0%, ${status.cor}10 100%); border: 2px solid ${status.cor}40; margin-top: 16px;">
                        <div class="rota-info-label" style="color: ${status.cor};">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            CondicAµes de Transito (Waze)
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                            <span style="font-size: 32px;">${status.icone}</span>
                            <div>
                                <div style="font-size: 18px; font-weight: 700; color: ${status.cor};">
                                    ${status.texto}
                                </div>
                                <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">
                                    ${analise.totalAlertas} alerta(s) detectado(s) nesta via
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Estatísticas detalhadas
                content += `<div class="rota-stats" style="margin-top: 12px;">`;

                if (analise.velocidadeMedia !== null) {
                    content += `
                        <div class="rota-stat-card" style="border-color: ${status.cor};">
                            <div class="rota-stat-value" style="color: ${status.cor};">${analise.velocidadeMedia}</div>
                            <div class="rota-stat-label">ðŸš— Velocidade Media (km/h)</div>
                        </div>
                    `;
                }

                if (analise.acidentes > 0) {
                    content += `
                        <div class="rota-stat-card" style="border-color: #ef4444;">
                            <div class="rota-stat-value" style="color: #ef4444;">${analise.acidentes}</div>
                            <div class="rota-stat-label">ðŸš¨ Acidente(s)</div>
                        </div>
                    `;
                }

                if (analise.congestionamentos > 0) {
                    content += `
                        <div class="rota-stat-card" style="border-color: #f59e0b;">
                            <div class="rota-stat-value" style="color: #f59e0b;">${analise.congestionamentos}</div>
                            <div class="rota-stat-label">ðŸš— Congestionamento(s)</div>
                        </div>
                    `;
                }

                if (analise.perigos > 0) {
                    content += `
                        <div class="rota-stat-card" style="border-color: #f59e0b;">
                            <div class="rota-stat-value" style="color: #f59e0b;">${analise.perigos}</div>
                            <div class="rota-stat-label">âš ï¸ Perigo(s) na Via</div>
                        </div>
                    `;
                }

                content += `</div>`;

                // Listar alertas proximos (maximo 5)
                if (analise.alertasProximos.length > 0) {
                    content += `
                        <div class="rota-info-item" style="margin-top: 16px;">
                            <div class="rota-info-label">
                                <i class="bi bi-list-ul"></i>
                                Alertas Proximos
                            </div>
                            <div style="margin-top: 12px;">
                    `;

                    analise.alertasProximos.slice(0, 5).forEach(alerta => {
                        content += `
                            <div style="
                                padding: 8px 12px;
                                background: rgba(255,255,255,0.05);
                                border-left: 3px solid ${alerta.cor};
                                border-radius: 4px;
                                margin-bottom: 8px;
                                font-size: 13px;
                            ">
                                <span style="font-size: 16px;">${alerta.icone}</span>
                                <strong>${alerta.tipo}</strong>
                                ${alerta.rua ? `<br><span style="color: #94a3b8;">ðŸ“ ${alerta.rua}</span>` : ''}
                                <br><span style="color: #64748b; font-size: 11px;">â†” ${alerta.distancia}m da rota</span>
                            </div>
                        `;
                    });

                    if (analise.alertasProximos.length > 5) {
                        content += `
                            <div style="text-align: center; color: #64748b; font-size: 12px; margin-top: 8px;">
                                + ${analise.alertasProximos.length - 5} alertas adicionais
                            </div>
                        `;
                    }

                    content += `
                            </div>
                        </div>
                    `;
                }

            } else if (wazeVisible && wazeMarkers.length > 0) {
                content += `
                    <div class="rota-info-item" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); margin-top: 16px;">
                        <div class="rota-info-label" style="color: #10b981;">
                            <i class="bi bi-check-circle-fill"></i>
                            CondicAµes de Transito (Waze)
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                            <span style="font-size: 32px;">âœ…</span>
                            <div>
                                <div style="font-size: 18px; font-weight: 700; color: #10b981;">
                                    Transito Normal
                                </div>
                                <div style="font-size: 13px; color: #94a3b8; margin-top: 4px;">
                                    Nenhum alerta detectado nesta via
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                content += `
                    <div class="rota-info-item" style="background: rgba(100, 116, 139, 0.1); border: 1px solid rgba(100, 116, 139, 0.3); margin-top: 16px;">
                        <div class="rota-info-label" style="color: #64748b;">
                            <i class="bi bi-info-circle-fill"></i>
                            Dados de Transito
                        </div>
                        <div style="font-size: 13px; color: #94a3b8; margin-top: 8px;">
                            Ative os alertas do Waze para ver condicAµes de Transito em tempo real
                        </div>
                    </div>
                `;
            }

            document.getElementById('rota-modal-body').innerHTML = content;
            document.getElementById('rota-modal').classList.add('active');
        }

        function closeRotaModal() {
            document.getElementById('rota-modal').classList.remove('active');

            if (selectedRotaLayer) {
                const hierarquia = selectedRotaLayer._hierarquia || 'Sem classificacao';
                const cor = hierarquiaCores[hierarquia] || '#f59e0b';
                selectedRotaLayer.setStyle({
                    color: cor,
                    weight: hierarquia === 'Estrutural' ? 4 : 3,
                    opacity: 0.8
                });
                selectedRotaLayer = null;
            }
        }

        function centerRotaOnMap() {
            if (selectedRotaLayer) {
                try {
                    mobilidadeMap.fitBounds(selectedRotaLayer.getBounds(), {
                        padding: [50, 50]
                    });
                } catch (e) {
                    // console.log('Nao foi possivel centralizar');
                }
            }
        }

        document.addEventListener('click', function (e) {
            const modal = document.getElementById('rota-modal');
            if (e.target === modal) {
                closeRotaModal();
            }
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeRotaModal();
            }
        });


        // ===== SISTEMA DE ROTEAMENTO E DESENHO =====
        let modoAtual = 'automatico';
        let coordOrigem = null;
        let coordDestino = null;
        let marcadorOrigem = null;
        let marcadorDestino = null;
        let rotaAutomatica = null;

        function iniciarDesenhoRota() {
            if (!kmlVisible) {
                alert('âš ï¸ Ative a visualizacao de rotas primeiro clicando em "Mostrar Rotas"');
                return;
            }

            // Abrir modal e GARANTIR QUE display SEJA FLEX
            const modal = document.getElementById('nova-rota-modal');
            modal.style.display = ''; // âœ… REMOVER display inline
            modal.classList.add('active');

            // Resetar para modo automatico
            modoAtual = 'automatico';
            mudarModo('automatico');

            // console.log('ðŸ“‹ Modal de nova rota aberto');
        }

        function mudarModo(modo) {
            modoAtual = modo;

            // console.log('ðŸ”„ Mudando para modo:', modo);

            // Se escolheu modo manual, FECHAR MODAL E INICIAR DESENHO
            if (modo === 'manual') {
                // console.log('ðŸŽ¨ Modo manual selecionado - fechando modal e iniciando desenho');

                // Fechar modal imediatamente
                const modal = document.getElementById('nova-rota-modal');
                modal.classList.remove('active');
                modal.style.display = 'none';

                // Aguardar um pouco e iniciar desenho
                setTimeout(() => {
                    iniciarDesenhoManual();
                }, 300);

                return; // âœ… SAIR DA FUNA‡AƒO
            }

            // Se for modo automatico, continuar normalmente
            document.getElementById('tab-automatico').classList.toggle('active', modo === 'automatico');
            document.getElementById('tab-manual').classList.toggle('active', modo === 'manual');

            document.getElementById('modo-automatico').classList.toggle('active', modo === 'automatico');
            document.getElementById('modo-manual').classList.toggle('active', modo === 'manual');

            // console.log('âœ… Modo alterado para:', modo);
        }

        async function buscarEndereco(tipo) {
            const input = tipo === 'origem' ? 'rota-origem' : 'rota-destino';
            const endereco = document.getElementById(input).value.trim();

            if (!endereco) {
                alert('âš ï¸ Digite um endereco!');
                return;
            }

            try {
                // Usar Nominatim do OpenStreetMap (gratuito)
                const url = `https://nominatim.openstreetmap.org/search?` +
                    `format=json&q=${encodeURIComponent(endereco)}&` +
                    `countrycodes=br&limit=1&` +
                    `viewbox=-43.7963,-23.0828,-43.1015,-22.7460&bounded=1`;

                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'SISCOR-Mobilidade/1.0'
                    }
                });

                const data = await response.json();

                if (data.length === 0) {
                    alert('âŒ Endereco nao encontrado! Tente ser mais especifico.');
                    return;
                }

                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);

                if (tipo === 'origem') {
                    coordOrigem = [lat, lon];

                    // Remover marcador anterior
                    if (marcadorOrigem) mobilidadeMap.removeLayer(marcadorOrigem);

                    // Adicionar marcador verde
                    marcadorOrigem = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'marker-origem',
                            html: '<i class="bi bi-geo-alt-fill"></i>',
                            iconSize: [30, 30]
                        })
                    }).addTo(mobilidadeMap);

                    // console.log('âœ… Origem definida:', data[0].display_name);
                } else {
                    coordDestino = [lat, lon];

                    // Remover marcador anterior
                    if (marcadorDestino) mobilidadeMap.removeLayer(marcadorDestino);

                    // Adicionar marcador vermelho
                    marcadorDestino = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'marker-destino',
                            html: '<i class="bi bi-flag-fill"></i>',
                            iconSize: [30, 30]
                        })
                    }).addTo(mobilidadeMap);

                    // console.log('âœ… Destino definido:', data[0].display_name);
                }

                // Centralizar mapa
                mobilidadeMap.setView([lat, lon], 14);

            } catch (error) {
                console.error('Erro ao buscar endereco:', error);
                alert('âŒ Erro ao buscar endereco. Tente novamente.');
            }
        }

        async function calcularRotaAutomatica() {
            if (!coordOrigem || !coordDestino) {
                alert('âš ï¸ Defina a origem e o destino primeiro!');
                return;
            }

            try {
                // Usar OSRM (Open Source Routing Machine) - gratuito
                const url = `https://router.project-osrm.org/route/v1/driving/` +
                    `${coordOrigem[1]},${coordOrigem[0]};${coordDestino[1]},${coordDestino[0]}?` +
                    `overview=full&geometries=geojson`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.code !== 'Ok') {
                    alert('âŒ Nao foi possivel calcular a rota!');
                    return;
                }

                const route = data.routes[0];
                const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);

                // Remover rota anterior
                if (rotaAutomatica) mobilidadeMap.removeLayer(rotaAutomatica);

                // Desenhar rota
                rotaAutomatica = L.polyline(coords, {
                    color: '#3b82f6',
                    weight: 5,
                    opacity: 0.7
                }).addTo(mobilidadeMap);

                // Salvar pontos para uso posterior
                pontosDesenho = coords;

                // Mostrar informacAµes
                const distancia = (route.distance / 1000).toFixed(2);
                const tempo = Math.round(route.duration / 60);

                document.getElementById('rota-distancia').textContent = distancia + ' km';
                document.getElementById('rota-tempo').textContent = tempo + ' min';
                document.getElementById('rota-info').style.display = 'block';
                document.getElementById('dados-rota').style.display = 'block';
                document.getElementById('btn-salvar-rota').style.display = 'flex';

                // Ajustar zoom
                mobilidadeMap.fitBounds(rotaAutomatica.getBounds(), { padding: [50, 50] });

                // console.log('âœ… Rota calculada:', distancia, 'km', tempo, 'min');

            } catch (error) {
                console.error('Erro ao calcular rota:', error);
                alert('âŒ Erro ao calcular rota. Tente novamente.');
            }
        }

        function iniciarDesenhoManual() {
            // console.log('ðŸŽ¨ INICIANDO DESENHO MANUAL COM SNAP-TO-ROAD');

            limparDesenhoTemporario();
            pontosDesenho = [];
            pontosChave = []; // Array para pontos-chave
            marcadoresTemporarios = [];
            linhaTemporaria = null;

            mobilidadeMap.off('click');

            desenhoModeAtivo = true;

            document.getElementById('desenho-indicator').classList.add('active');
            document.getElementById('desenho-controls').classList.add('active');
            document.getElementById('mobilidade-map').style.cursor = 'crosshair';

            document.querySelector('#desenho-indicator span').textContent =
                'ðŸŽ¯ Clique no mapa para adicionar pontos â€¢ Arraste os pontos para ajustar';

            // ===== CLIQUE PARA ADICIONAR PONTO =====
            mobilidadeMap.on('click', async function (e) {
                if (!desenhoModeAtivo) return;

                const latlng = e.latlng;

                // Adicionar aos pontos-chave
                pontosChave.push({
                    lat: latlng.lat,
                    lng: latlng.lng
                });

                // console.log('ðŸ“ Ponto', pontosChave.length, 'adicionado:', latlng);

                // Redesenhar marcadores
                redesenharMarcadores();

                // Recalcular rota com snap-to-road
                if (pontosChave.length >= 2) {
                    await recalcularRota();
                }
            });

            // console.log('âœ… Modo de desenho ativo');
        }

        function adicionarMarcadorArrastavel(latlng, index) {
            // Marcador arrastavel
            const marcador = L.marker(latlng, {
                draggable: true,
                icon: L.divIcon({
                    className: 'ponto-marcador',
                    html: `<div style="
                        background: #ef4444;
                        color: white;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 16px;
                        border: 3px solid white;
                        box-shadow: 0 3px 10px rgba(0,0,0,0.5);
                        cursor: move;
                    ">${index + 1}</div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(mobilidadeMap);

            // Guardar indice
            marcador._idx = index;

            // Atualizar posicao ao arrastar
            marcador.on('drag', function (e) {
                const marker = e.target;
                const pos = marker.getLatLng();
                pontosDesenho[marker._idx] = pos;
                atualizarLinha();
            });

            // Duplo-clique remove
            marcador.on('dblclick', function (e) {
                L.DomEvent.stopPropagation(e);
                if (confirm('Remover este ponto?')) {
                    removerPonto(marcador._idx);
                }
            });

            marcadoresTemporarios.push(marcador);
        }

        function atualizarLinha() {
            if (linhaTemporaria) {
                mobilidadeMap.removeLayer(linhaTemporaria);
            }

            if (pontosDesenho.length > 1) {
                linhaTemporaria = L.polyline(pontosDesenho, {
                    color: '#3b82f6',
                    weight: 6,
                    opacity: 0.8
                }).addTo(mobilidadeMap);
            }
        }

        function removerPonto(index) {
            pontosDesenho.splice(index, 1);

            // Limpar e redesenhar tudo
            marcadoresTemporarios.forEach(m => mobilidadeMap.removeLayer(m));
            marcadoresTemporarios = [];

            pontosDesenho.forEach((pt, i) => {
                adicionarMarcadorArrastavel(pt, i);
            });

            atualizarLinha();

            // console.log('ðŸ—‘ï¸ Ponto removido. Restam:', pontosDesenho.length);
        }

        function desfazerPonto() {
            if (pontosChave.length === 0) {
                alert('âš ï¸ Nenhum ponto para desfazer!');
                return;
            }

            pontosChave.pop();

            // console.log('â†©ï¸ Desfeito. Restam:', pontosChave.length);

            // Redesenhar tudo
            redesenharMarcadores();

            // Recalcular rota
            if (pontosChave.length >= 2) {
                recalcularRota();
            } else {
                // Remover linha se menos de 2 pontos
                if (linhaTemporaria) {
                    mobilidadeMap.removeLayer(linhaTemporaria);
                    linhaTemporaria = null;
                }
                pontosDesenho = [];
            }
        }

        function finalizarDesenho() {
            // console.log('ðŸ FINALIZANDO');

            if (pontosDesenho.length < 2) {
                alert('âš ï¸ Adicione pelo menos 2 pontos!');
                return;
            }

            desenhoModeAtivo = false;
            document.getElementById('mobilidade-map').style.cursor = '';
            document.getElementById('desenho-indicator').classList.remove('active');
            document.getElementById('desenho-controls').classList.remove('active');

            mobilidadeMap.off('click');

            let distanciaTotal = 0;
            for (let i = 0; i < pontosDesenho.length - 1; i++) {
                distanciaTotal += mobilidadeMap.distance(pontosDesenho[i], pontosDesenho[i + 1]);
            }
            const distanciaKm = (distanciaTotal / 1000).toFixed(2);

            const nome = prompt('ðŸ“ Nome da rota:');
            if (!nome) {
                cancelarDesenho();
                return;
            }

            const hierarquia = prompt('ðŸ“Š Hierarquia:\n\nEstruturalArterial primaria\nArterial secundaria\nColetora\n\nDigite:') || 'Coletora';

            salvarRotaDesenhada(nome, hierarquia);
        }

        function salvarRotaDesenhada(nome, hierarquia) {
            const cor = hierarquiaCores[hierarquia] || '#10b981';
            const rotaId = Date.now();

            // Criar rota permanente
            const novaRota = L.polyline(pontosDesenho, {
                color: cor,
                weight: hierarquia === 'Estrutural' ? 4 : 3,
                opacity: 0.8,
                interactive: true
            }).addTo(mobilidadeMap);

            novaRota.feature = {
                properties: {
                    name: nome,
                    Hierarquia: hierarquia,
                    Trecho: 'Toda extensao',
                    custom: true,
                    id: rotaId,
                    data_criacao: new Date().toISOString()
                }
            };

            novaRota._hierarquia = hierarquia;
            novaRota._rotaId = rotaId;

            novaRota.on('click', function (e) {
                L.DomEvent.stopPropagation(e);
                showRotaModal(novaRota);
            });

            novaRota.on('mouseover', function () {
                this.setStyle({ color: '#fbbf24', weight: 5, opacity: 1 });
            });

            novaRota.on('mouseout', function () {
                if (selectedRotaLayer !== this) {
                    this.setStyle({
                        color: cor,
                        weight: hierarquia === 'Estrutural' ? 4 : 3,
                        opacity: 0.8
                    });
                }
            });

            if (!window.rotasClicaveis) window.rotasClicaveis = [];
            window.rotasClicaveis.push(novaRota);

            if (kmlLayer) kmlLayer.addLayer(novaRota);

            // Salvar no localStorage
            salvarRotaNoStorage(rotaId, nome, hierarquia, '', '', pontosDesenho, cor);

            limparDesenhoTemporario();
            pontosDesenho = [];

            alert(`âœ… Rota "${nome}" salva com sucesso!`);
        }

        function cancelarDesenho() {
            // console.log('âŒ Cancelado');

            desenhoModeAtivo = false;
            document.getElementById('mobilidade-map').style.cursor = '';
            document.getElementById('desenho-indicator').classList.remove('active');
            document.getElementById('desenho-controls').classList.remove('active');

            mobilidadeMap.off('click');

            limparDesenhoTemporario();
            pontosDesenho = [];
        }

        function adicionarPontoDesenhoManual(e) {
            if (!desenhoModeAtivo) {
                // console.log('âš ï¸ Modo de desenho nao esta ativo!');
                return;
            }

            const latlng = e.latlng;

            // Evitar pontos duplicados muito proximos (menos de 10 metros)
            if (pontosDesenho.length > 0) {
                const ultimoPonto = pontosDesenho[pontosDesenho.length - 1];
                const distancia = mobilidadeMap.distance(ultimoPonto, latlng);
                if (distancia < 10) return;
            }

            pontosDesenho.push(latlng);

            // Log a cada 50 pontos
            if (pontosDesenho.length % 50 === 0) {
                // console.log('ðŸ“ Pontos desenhados:', pontosDesenho.length);
            }

            // Adicionar marcador visual a cada 20 pontos
            if (pontosDesenho.length % 20 === 0) {
                const marker = L.circleMarker(latlng, {
                    radius: 5,
                    color: '#10b981',
                    fillColor: '#10b981',
                    fillOpacity: 1,
                    weight: 2
                }).addTo(mobilidadeMap);

                marcadoresTemporarios.push(marker);
            }

            // Desenhar/atualizar linha
            if (pontosDesenho.length > 1) {
                if (linhaTemporaria) {
                    mobilidadeMap.removeLayer(linhaTemporaria);
                }

                linhaTemporaria = L.polyline(pontosDesenho, {
                    color: '#10b981',
                    weight: 5,
                    opacity: 0.8,
                    smoothFactor: 1
                }).addTo(mobilidadeMap);
            }

            // Primeiro ponto - mostrar confirmacao
            if (pontosDesenho.length === 1) {
                // console.log('âœ… Primeiro ponto adicionado! Continue desenhando...');
            }
        }

        function desfazerPonto() {
            // console.log('');
            // console.log('â•â•â• DESFAZER ACIONADO â•â•â•');
            // console.log('Pontos antes:', pontosDesenho.length);
            // console.log('Marcadores antes:', marcadoresTemporarios.length);

            if (pontosDesenho.length === 0) {
                // console.log('âš ï¸ Nenhum ponto para desfazer');
                alert('Nenhum ponto para desfazer!');
                return;
            }

            // Remover 1 ponto
            const pontoRemovido = pontosDesenho.pop();
            // console.log('âœ… Ponto removido:', pontoRemovido);
            // console.log('ðŸ“Š Pontos restantes:', pontosDesenho.length);

            // Remover ultimo marcador
            if (marcadoresTemporarios.length > 0) {
                const marcador = marcadoresTemporarios.pop();
                try {
                    mobilidadeMap.removeLayer(marcador);
                    // console.log('ðŸŸ¢ Marcador removido do mapa');
                } catch (err) {
                    console.error('âŒ Erro ao remover marcador:', err);
                }
            }

            // Remover linha antiga
            if (linhaTemporaria) {
                try {
                    mobilidadeMap.removeLayer(linhaTemporaria);
                    linhaTemporaria = null;
                    // console.log('ðŸ—‘ï¸ Linha antiga removida');
                } catch (err) {
                    console.error('âŒ Erro ao remover linha:', err);
                }
            }

            // Redesenhar linha se ainda houver pontos
            if (pontosDesenho.length > 1) {
                // console.log('ðŸ“ Redesenhando linha com', pontosDesenho.length, 'pontos...');
                try {
                    linhaTemporaria = L.polyline(pontosDesenho, {
                        color: '#10b981',
                        weight: 8,
                        opacity: 0.9
                    }).addTo(mobilidadeMap);
                    // console.log('âœ… Linha redesenhada!');
                } catch (err) {
                    console.error('âŒ Erro ao redesenhar linha:', err);
                }
            } else if (pontosDesenho.length === 1) {
                // console.log('â„¹ï¸ Apenas 1 ponto restante - sem linha');
            } else {
                // console.log('â„¹ï¸ Todos os pontos removidos');
            }

            // console.log('â•â•â• FIM DO DESFAZER â•â•â•');
            // console.log('');
        }

        function finalizarDesenho() {
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ FINALIZANDO DESENHO');
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ“Š Pontos-chave:', pontosChave.length);
            // console.log('ðŸ“Š Pontos da rota:', pontosDesenho.length);

            if (pontosDesenho.length < 2) {
                alert('âš ï¸ VocAª precisa adicionar pelo menos 2 pontos!');
                return;
            }

            desenhoModeAtivo = false;
            modoInterativo = false;
            document.getElementById('mobilidade-map').style.cursor = '';
            document.getElementById('desenho-indicator').classList.remove('active');
            document.getElementById('desenho-controls').classList.remove('active');

            mobilidadeMap.off('mousedown');
            mobilidadeMap.off('mousemove');
            mobilidadeMap.off('mouseup');
            mobilidadeMap.off('click');

            let distanciaTotal = 0;
            for (let i = 0; i < pontosDesenho.length - 1; i++) {
                distanciaTotal += mobilidadeMap.distance(pontosDesenho[i], pontosDesenho[i + 1]);
            }
            const distanciaKm = (distanciaTotal / 1000).toFixed(2);

            // console.log('ðŸ“ DistA¢ncia:', distanciaKm, 'km');

            const nome = prompt('ðŸ“ Nome da rota:');
            if (!nome) {
                cancelarDesenho();
                return;
            }

            const hierarquia = prompt('ðŸ“Š Hierarquia:\n\n1. Estrutural\n2. Arterial primaria\n3. Arterial secundaria\n4. Coletora\n\nDigite o nome:') || 'Coletora';

            salvarRotaDesenhada(nome, hierarquia, distanciaKm);
        }

        function cancelarDesenho() {
            // console.log('âŒ Cancelando desenho...');

            // Limpar desenhos
            limparDesenhoTemporario();
            desenhoModeAtivo = false;
            pontosDesenho = [];


            // Remover indicadores
            document.getElementById('desenho-indicator').classList.remove('active');
            document.getElementById('desenho-controls').classList.remove('active');
            document.getElementById('mobilidade-map').style.cursor = '';

            // Remover eventos
            mobilidadeMap.off('mousedown');
            mobilidadeMap.off('mousemove');
            mobilidadeMap.off('mouseup');
            mobilidadeMap.off('click');

            // console.log('âœ… Desenho cancelado - Sistema pronto para nova operacao');
        }

        function limparDesenhoTemporario() {
            if (linhaTemporaria) {
                mobilidadeMap.removeLayer(linhaTemporaria);
                linhaTemporaria = null;
            }

            if (rotaAutomatica) {
                mobilidadeMap.removeLayer(rotaAutomatica);
                rotaAutomatica = null;
            }

            marcadoresTemporarios.forEach(marker => mobilidadeMap.removeLayer(marker));
            marcadoresTemporarios = [];

            if (marcadorOrigem) {
                mobilidadeMap.removeLayer(marcadorOrigem);
                marcadorOrigem = null;
            }

            if (marcadorDestino) {
                mobilidadeMap.removeLayer(marcadorDestino);
                marcadorDestino = null;
            }
        }

        // ===== FUNA‡A•ES AUXILIARES PARA DESENHO =====

        function mostrarLoading(mostrar) {
            const indicator = document.getElementById('desenho-indicator');
            if (!indicator) return;

            const span = indicator.querySelector('span');
            if (!span) return;

            if (mostrar) {
                span.innerHTML = '<i class="bi bi-hourglass-split" style="animation: spin 1s linear infinite;"></i> Calculando rota nas vias...';
            } else {
                span.textContent = ' Clique no mapa para adicionar pontos Arraste os pontos para ajustar';
            }
        }

        async function recalcularRota() {
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ”„ RECALCULANDO ROTA');
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ“ Pontos-chave:', pontosChave.length);

            if (pontosChave.length < 2) {
                // console.log('âš ï¸ Menos de 2 pontos - removendo linha');
                if (linhaTemporaria) {
                    mobilidadeMap.removeLayer(linhaTemporaria);
                    linhaTemporaria = null;
                }
                return;
            }

            // Remover linha antiga
            if (linhaTemporaria) {
                mobilidadeMap.removeLayer(linhaTemporaria);
                linhaTemporaria = null;
            }

            mostrarLoading(true);

            try {
                // Criar string de coordenadas para OSRM
                const coords = pontosChave.map(p => `${p.lng},${p.lat}`).join(';');
                const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;

                // console.log(' Chamando OSRM...');
                // console.log('ðŸ“¡ URL:', url);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                // console.log(' Resposta recebida:', response.status);

                if (response.ok) {
                    const data = await response.json();

                    if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const coordinates = route.geometry.coordinates;

                        // Converter para LatLng do Leaflet
                        const pontosRota = coordinates.map(coord => L.latLng(coord[1], coord[0]));

                        // Criar linha na rota
                        linhaTemporaria = L.polyline(pontosRota, {
                            color: '#10b981',
                            weight: 6,
                            opacity: 0.8
                        }).addTo(mobilidadeMap);

                        // Salvar pontos para uso posterior
                        pontosDesenho = pontosRota;

                        const distanciaKm = (route.distance / 1000).toFixed(2);
                        // console.log(' Rota calculada:', pontosRota.length, 'pontos');
                        // console.log(' Distancia:', distanciaKm, 'km');

                        mostrarLoading(false);
                        return;
                    }
                }

                throw new Error('OSRM nao retornou rota valida');

            } catch (error) {
                console.warn(' Snap-to-road falhou:', error.message);
                // console.log('Usando linha reta tracejada como fallback');

                // FALLBACK: Linha reta tracejada
                linhaTemporaria = L.polyline(pontosChave, {
                    color: '#f59e0b',
                    weight: 6,
                    opacity: 0.6,
                    dashArray: '10, 10'
                }).addTo(mobilidadeMap);

                pontosDesenho = [...pontosChave];

                mostrarLoading(false);
            }

            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('âœ… RECALCULO CONCLUADO');
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        }

        function salvarNovaRota() {
            // console.log('ðŸ’¾ Salvando nova rota...');

            const nome = document.getElementById('nova-rota-nome').value.trim();
            const hierarquia = document.getElementById('nova-rota-hierarquia').value;
            const trecho = document.getElementById('nova-rota-trecho').value.trim();
            const obs = document.getElementById('nova-rota-obs').value.trim();

            if (!nome || !hierarquia) {
                alert('âš ï¸ Preencha o nome e a classificacao da rota!');
                return;
            }

            if (pontosDesenho.length < 2) {
                alert('âš ï¸ A rota precisa ter pelo menos 2 pontos!');
                return;
            }

            const cor = hierarquiaCores[hierarquia] || '#10b981';

            // Criar rota visual no mapa
            const novaRota = L.polyline(pontosDesenho, {
                color: cor,
                weight: hierarquia === 'Estrutural' ? 4 : 3,
                opacity: 0.8,
                interactive: true
            }).addTo(mobilidadeMap);

            novaRota.feature = {
                properties: {
                    name: nome,
                    Hierarquia: hierarquia,
                    Trecho: trecho || 'Toda extensao',
                    descricao: obs || '',
                    custom: true, // MARCAR COMO ROTA CUSTOMIZADA
                    data_criacao: new Date().toISOString()
                }
            };

            novaRota._hierarquia = hierarquia;

            // Eventos da rota
            novaRota.on('click', function (e) {
                L.DomEvent.stopPropagation(e);
                showRotaModal(novaRota);
            });

            novaRota.on('mouseover', function () {
                this.setStyle({ color: '#fbbf24', weight: 5, opacity: 1 });
            });

            novaRota.on('mouseout', function () {
                if (selectedRotaLayer !== this) {
                    this.setStyle({
                        color: cor,
                        weight: hierarquia === 'Estrutural' ? 4 : 3,
                        opacity: 0.8
                    });
                }
            });

            // Adicionar ao array de rotas
            if (!window.rotasClicaveis) window.rotasClicaveis = [];
            window.rotasClicaveis.push(novaRota);

            if (kmlLayer) kmlLayer.addLayer(novaRota);

            // ===== SALVAR NO LOCALSTORAGE =====
            salvarRotaNoStorage(novaRota, nome, hierarquia, trecho, obs, pontosDesenho);

            limparDesenhoTemporario();
            cancelarNovaRota();
            atualizarEstatisticas();

            // console.log('âœ… Rota salva com sucesso!');
            alert(`âœ… Rota "${nome}" salva com sucesso!`);
        }

        function salvarRotaNoStorage(rota, nome, hierarquia, trecho, obs, pontos) {
            try {
                // Pegar rotas existentes
                let rotasSalvas = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');

                // Converter pontos para formato simples
                const pontosSimples = pontos.map(p => ({
                    lat: p.lat,
                    lng: p.lng
                }));

                // Adicionar nova rota
                rotasSalvas.push({
                    id: Date.now(),
                    nome: nome,
                    hierarquia: hierarquia,
                    trecho: trecho,
                    observacoes: obs,
                    pontos: pontosSimples,
                    cor: hierarquiaCores[hierarquia] || '#10b981',
                    data_criacao: new Date().toISOString()
                });

                // Salvar no localStorage
                localStorage.setItem('rotas_customizadas', JSON.stringify(rotasSalvas));

                // console.log('âœ… Rota salva no localStorage');
                // console.log('ðŸ“Š Total de rotas salvas:', rotasSalvas.length);

            } catch (error) {
                console.error('âŒ Erro ao salvar rota:', error);
                alert('âš ï¸ Erro ao salvar rota no navegador.');
            }
        }

        function carregarRotasSalvas() {
            try {
                const rotasSalvas = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');

                // console.log('ðŸ“‚ Carregando rotas salvas...');
                // console.log('ðŸ“Š Encontradas', rotasSalvas.length, 'rotas');

                if (rotasSalvas.length === 0) {
                    // console.log('â„¹ï¸ Nenhuma rota salva encontrada');
                    return;
                }

                rotasSalvas.forEach((rotaData, index) => {
                    try {
                        console.log(`ðŸ“ [${index + 1}] Carregando: ${rotaData.nome}`);

                        // Converter pontos de volta para LatLng
                        const pontos = rotaData.pontos.map(p => L.latLng(p.lat, p.lng));

                        // Criar rota no mapa
                        const rota = L.polyline(pontos, {
                            color: rotaData.cor,
                            weight: rotaData.hierarquia === 'Estrutural' ? 4 : 3,
                            opacity: 0.8,
                            interactive: true
                        }).addTo(mobilidadeMap);

                        rota.feature = {
                            properties: {
                                name: rotaData.nome,
                                Hierarquia: rotaData.hierarquia,
                                Trecho: rotaData.trecho,
                                descricao: rotaData.observacoes,
                                custom: true,
                                data_criacao: rotaData.data_criacao
                            }
                        };

                        rota._hierarquia = rotaData.hierarquia;

                        // Eventos
                        rota.on('click', function (e) {
                            L.DomEvent.stopPropagation(e);
                            showRotaModal(rota);
                        });

                        rota.on('mouseover', function () {
                            this.setStyle({ color: '#fbbf24', weight: 5, opacity: 1 });
                        });

                        rota.on('mouseout', function () {
                            if (selectedRotaLayer !== this) {
                                this.setStyle({
                                    color: rotaData.cor,
                                    weight: rotaData.hierarquia === 'Estrutural' ? 4 : 3,
                                    opacity: 0.8
                                });
                            }
                        });

                        // Adicionar ao array
                        if (!window.rotasClicaveis) window.rotasClicaveis = [];
                        window.rotasClicaveis.push(rota);

                        if (kmlLayer) kmlLayer.addLayer(rota);

                        console.log(`   âœ… Rota "${rotaData.nome}" carregada`);

                    } catch (err) {
                        console.error(`   âŒ Erro ao carregar rota ${index + 1}:`, err);
                    }
                });

                // console.log('âœ… Todas as rotas salvas foram carregadas');
                atualizarEstatisticas();

            } catch (error) {
                console.error('âŒ Erro ao carregar rotas salvas:', error);
            }
        }

        function apagarRotaById(id) {
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ—‘ï¸ APAGANDO ROTA:', id);
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            event.stopPropagation(); // âœ… IMPORTANTE: Evitar que o clique propague

            if (!confirm('âš ï¸ Deseja realmente apagar esta rota?\n\nEsta acao nao pode ser desfeita!')) {
                // console.log('âŒ Usuario cancelou');
                return;
            }

            try {
                // Carregar rotas do localStorage
                let rotasSalvas = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');
                // console.log('ðŸ“¦ Total de rotas antes:', rotasSalvas.length);

                // Filtrar removendo a rota com o ID especificado
                const rotasFiltradas = rotasSalvas.filter(rota => rota.id !== id);
                // console.log('ðŸ“¦ Total de rotas depois:', rotasFiltradas.length);

                if (rotasFiltradas.length === rotasSalvas.length) {
                    console.warn('âš ï¸ Rota nao encontrada no localStorage');
                    alert('âš ï¸ Rota nao encontrada!');
                    return;
                }

                // Salvar de volta
                localStorage.setItem('rotas_customizadas', JSON.stringify(rotasFiltradas));
                // console.log('âœ… localStorage atualizado');

                // Verificar se salvou
                const verificacao = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');
                // console.log('âœ… Verificacao: agora tem', verificacao.length, 'rotas');

                // Remover do mapa
                if (window.rotasClicaveis) {
                    const rotaNoMapa = window.rotasClicaveis.find(r => r._rotaId === id);
                    if (rotaNoMapa) {
                        mobilidadeMap.removeLayer(rotaNoMapa);
                        window.rotasClicaveis = window.rotasClicaveis.filter(r => r._rotaId !== id);
                        // console.log('âœ… Rota removida do mapa');
                    }
                }

                // Atualizar interface
                atualizarListaRotasCustomizadas();
                atualizarEstatisticas();

                // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                // console.log('âœ… ROTA APAGADA COM SUCESSO!');
                // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                alert('âœ… Rota apagada com sucesso!');

            } catch (error) {
                console.error('âŒ Erro ao apagar rota:', error);
                alert('âŒ Erro ao apagar rota: ' + error.message);
            }
        }

        function apagarRotasSelecionadas() {
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ—‘ï¸ APAGANDO ROTAS SELECIONADAS');
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            const checkboxes = document.querySelectorAll('.rota-custom-checkbox:checked');
            // console.log('ðŸ“‹ Checkboxes marcados:', checkboxes.length);

            if (checkboxes.length === 0) {
                alert('âš ï¸ Selecione pelo menos uma rota para apagar!');
                // console.log('âŒ Nenhum checkbox marcado');
                return;
            }

            if (!confirm(`âš ï¸ Deseja realmente apagar ${checkboxes.length} rota(s)?\n\nEsta acao nao pode ser desfeita!`)) {
                // console.log('âŒ Usuario cancelou');
                return;
            }

            try {
                const idsParaApagar = Array.from(checkboxes).map(cb => parseInt(cb.dataset.rotaId));
                // console.log('ðŸ—‘ï¸ IDs para apagar:', idsParaApagar);

                let rotasSalvas = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');
                // console.log('ðŸ“¦ Total antes:', rotasSalvas.length);

                // Filtrar
                rotasSalvas = rotasSalvas.filter(rota => !idsParaApagar.includes(rota.id));
                // console.log('ðŸ“¦ Total depois:', rotasSalvas.length);

                // Salvar
                localStorage.setItem('rotas_customizadas', JSON.stringify(rotasSalvas));
                // console.log('âœ… localStorage atualizado');

                // Remover do mapa
                if (window.rotasClicaveis) {
                    idsParaApagar.forEach(id => {
                        const rotaNoMapa = window.rotasClicaveis.find(r => r._rotaId === id);
                        if (rotaNoMapa) {
                            mobilidadeMap.removeLayer(rotaNoMapa);
                        }
                    });
                    window.rotasClicaveis = window.rotasClicaveis.filter(r => !idsParaApagar.includes(r._rotaId));
                }

                // console.log('âœ…', checkboxes.length, 'rotas apagadas');

                atualizarListaRotasCustomizadas();
                atualizarEstatisticas();

                // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                // console.log('âœ… EXCLUSAƒO CONCLUADA!');
                // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                alert(`âœ… ${checkboxes.length} rota(s) apagada(s) com sucesso!`);

            } catch (error) {
                console.error('âŒ Erro:', error);
                alert('âŒ Erro ao apagar rotas: ' + error.message);
            }
        }

        function centralizarRotaById(id) {
            // console.log('ðŸŽ¯ Centralizando rota:', id);

            event.stopPropagation(); // âœ… IMPORTANTE

            // Tentar encontrar no mapa primeiro
            if (window.rotasClicaveis) {
                const rotaNoMapa = window.rotasClicaveis.find(r => r._rotaId === id);
                if (rotaNoMapa) {
                    mobilidadeMap.fitBounds(rotaNoMapa.getBounds(), { padding: [50, 50] });
                    // console.log('âœ… Centralizado via mapa');
                    return;
                }
            }

            // Se nao encontrou, buscar no localStorage
            const rotasSalvas = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');
            const rotaData = rotasSalvas.find(r => r.id === id);

            if (!rotaData || !rotaData.pontos || rotaData.pontos.length === 0) {
                alert('âŒ Rota nao encontrada!');
                // console.log('âŒ Rota nao encontrada');
                return;
            }

            const lats = rotaData.pontos.map(p => p.lat);
            const lngs = rotaData.pontos.map(p => p.lng);

            const bounds = L.latLngBounds(
                [Math.min(...lats), Math.min(...lngs)],
                [Math.max(...lats), Math.max(...lngs)]
            );

            mobilidadeMap.fitBounds(bounds, { padding: [50, 50] });
            // console.log('âœ… Centralizado via localStorage');
        }

        function limparRotasSalvas() {
            if (confirm('âš ï¸ Deseja realmente apagar TODAS as rotas customizadas?\n\nEsta acao nao pode ser desfeita!')) {
                localStorage.removeItem('rotas_customizadas');
                alert('âœ… Rotas customizadas removidas!\n\nRecarregue a pagina para aplicar.');
                // console.log('ðŸ—‘ï¸ Rotas salvas apagadas do localStorage');
            }
        }

        function exportarRotas() {
            try {
                const rotasSalvas = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');

                if (rotasSalvas.length === 0) {
                    alert('âš ï¸ Nenhuma rota para exportar!');
                    return;
                }

                const dataStr = JSON.stringify(rotasSalvas, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `rotas_customizadas_${Date.now()}.json`;
                link.click();

                // console.log('âœ… Rotas exportadas');
                alert(`âœ… ${rotasSalvas.length} rotas exportadas com sucesso!`);

            } catch (error) {
                console.error('âŒ Erro ao exportar:', error);
                alert('âŒ Erro ao exportar rotas');
            }
        }

        function salvarRotaNoStorage(rota, nome, hierarquia, trecho, obs, pontos) {
            try {
                // Pegar rotas existentes
                let rotasSalvas = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');

                // Converter pontos para formato simples
                const pontosSimples = pontos.map(p => ({
                    lat: p.lat,
                    lng: p.lng
                }));

                // Adicionar nova rota
                rotasSalvas.push({
                    id: Date.now(),
                    nome: nome,
                    hierarquia: hierarquia,
                    trecho: trecho,
                    observacoes: obs,
                    pontos: pontosSimples,
                    cor: hierarquiaCores[hierarquia] || '#10b981',
                    data_criacao: new Date().toISOString()
                });

                // Salvar no localStorage
                localStorage.setItem('rotas_customizadas', JSON.stringify(rotasSalvas));

                // console.log('âœ… Rota salva no localStorage');
                // console.log('ðŸ“Š Total de rotas salvas:', rotasSalvas.length);

            } catch (error) {
                console.error('âŒ Erro ao salvar rota:', error);
                alert('âš ï¸ Erro ao salvar rota no navegador.');
            }
        }

        function carregarRotasSalvas() {
            try {
                const rotasSalvas = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');

                // console.log('ðŸ“‚ Carregando rotas salvas...');
                // console.log('ðŸ“Š Encontradas', rotasSalvas.length, 'rotas');

                if (rotasSalvas.length === 0) {
                    // console.log('â„¹ï¸ Nenhuma rota salva encontrada');
                    return;
                }

                rotasSalvas.forEach((rotaData, index) => {
                    try {
                        console.log(`ðŸ“ [${index + 1}] Carregando: ${rotaData.nome}`);

                        // Converter pontos de volta para LatLng
                        const pontos = rotaData.pontos.map(p => L.latLng(p.lat, p.lng));

                        // Criar rota no mapa
                        const rota = L.polyline(pontos, {
                            color: rotaData.cor,
                            weight: rotaData.hierarquia === 'Estrutural' ? 4 : 3,
                            opacity: 0.8,
                            interactive: true
                        }).addTo(mobilidadeMap);

                        rota.feature = {
                            properties: {
                                name: rotaData.nome,
                                Hierarquia: rotaData.hierarquia,
                                Trecho: rotaData.trecho,
                                descricao: rotaData.observacoes,
                                custom: true,
                                data_criacao: rotaData.data_criacao
                            }
                        };

                        rota._hierarquia = rotaData.hierarquia;

                        // Eventos
                        rota.on('click', function (e) {
                            L.DomEvent.stopPropagation(e);
                            showRotaModal(rota);
                        });

                        rota.on('mouseover', function () {
                            this.setStyle({ color: '#fbbf24', weight: 5, opacity: 1 });
                        });

                        rota.on('mouseout', function () {
                            if (selectedRotaLayer !== this) {
                                this.setStyle({
                                    color: rotaData.cor,
                                    weight: rotaData.hierarquia === 'Estrutural' ? 4 : 3,
                                    opacity: 0.8
                                });
                            }
                        });

                        // Adicionar ao array
                        if (!window.rotasClicaveis) window.rotasClicaveis = [];
                        window.rotasClicaveis.push(rota);

                        if (kmlLayer) kmlLayer.addLayer(rota);

                        console.log(`   âœ… Rota "${rotaData.nome}" carregada`);

                    } catch (err) {
                        console.error(`   âŒ Erro ao carregar rota ${index + 1}:`, err);
                    }
                });

                // console.log('âœ… Todas as rotas salvas foram carregadas');
                atualizarEstatisticas();

            } catch (error) {
                console.error('âŒ Erro ao carregar rotas salvas:', error);
            }
        }

        function limparRotasSalvas() {
            if (confirm('âš ï¸ Deseja realmente apagar TODAS as rotas customizadas?\n\nEsta acao nao pode ser desfeita!')) {
                localStorage.removeItem('rotas_customizadas');
                alert('âœ… Rotas customizadas removidas!\n\nRecarregue a pagina para aplicar.');
                // console.log('ðŸ—‘ï¸ Rotas salvas apagadas do localStorage');
            }
        }

        function exportarRotas() {
            try {
                const rotasSalvas = JSON.parse(localStorage.getItem('rotas_customizadas') || '[]');

                if (rotasSalvas.length === 0) {
                    alert('âš ï¸ Nenhuma rota para exportar!');
                    return;
                }

                const dataStr = JSON.stringify(rotasSalvas, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `rotas_customizadas_${Date.now()}.json`;
                link.click();

                // console.log('âœ… Rotas exportadas');
                alert(`âœ… ${rotasSalvas.length} rotas exportadas com sucesso!`);

            } catch (error) {
                console.error('âŒ Erro ao exportar:', error);
                alert('âŒ Erro ao exportar rotas');
            }
        }

        function cancelarNovaRota() {
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ”„ CANCELANDO NOVA ROTA');
            // console.log('   Stack trace:');
            console.trace();
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            limparDesenhoTemporario();
            cancelarDesenho();

            const modal = document.getElementById('nova-rota-modal');
            modal.classList.remove('active');
            modal.style.display = '';

            // Limpar campos
            document.getElementById('rota-origem').value = '';
            document.getElementById('rota-destino').value = '';
            document.getElementById('nova-rota-nome').value = '';
            document.getElementById('nova-rota-hierarquia').value = '';
            document.getElementById('nova-rota-trecho').value = '';
            document.getElementById('nova-rota-obs').value = '';

            document.getElementById('rota-info').style.display = 'none';
            document.getElementById('dados-rota').style.display = 'none';
            document.getElementById('btn-salvar-rota').style.display = 'none';

            coordOrigem = null;
            coordDestino = null;
            pontosDesenho = [];

            modoAtual = 'automatico';
            document.getElementById('tab-automatico').classList.add('active');
            document.getElementById('tab-manual').classList.remove('active');
            document.getElementById('modo-automatico').classList.add('active');
            document.getElementById('modo-automatico').style.display = 'block';
            document.getElementById('modo-manual').classList.remove('active');
            document.getElementById('modo-manual').style.display = 'none';

            // console.log('âœ… Tudo resetado');
        }

        function cancelarDesenho() {
            // console.log('âŒ Desenho cancelado');

            desenhoModeAtivo = false;
            modoInterativo = false;
            document.getElementById('mobilidade-map').style.cursor = '';
            document.getElementById('desenho-indicator').classList.remove('active');
            document.getElementById('desenho-controls').classList.remove('active');

            mobilidadeMap.off('mousedown');
            mobilidadeMap.off('mousemove');
            mobilidadeMap.off('mouseup');
            mobilidadeMap.off('click');

            limparDesenhoTemporario();
            pontosDesenho = [];
            pontosChave = [];
        }

        function limparDesenhoTemporario() {
            if (linhaTemporaria) {
                mobilidadeMap.removeLayer(linhaTemporaria);
                linhaTemporaria = null;
            }

            if (rotaAutomatica) {
                mobilidadeMap.removeLayer(rotaAutomatica);
                rotaAutomatica = null;
            }

            marcadoresTemporarios.forEach(marker => mobilidadeMap.removeLayer(marker));
            marcadoresTemporarios = [];

            if (marcadorOrigem) {
                mobilidadeMap.removeLayer(marcadorOrigem);
                marcadorOrigem = null;
            }

            if (marcadorDestino) {
                mobilidadeMap.removeLayer(marcadorDestino);
                marcadorDestino = null;
            }
        }

        function salvarNovaRota() {
            const nome = document.getElementById('nova-rota-nome').value.trim();
            const hierarquia = document.getElementById('nova-rota-hierarquia').value;
            const trecho = document.getElementById('nova-rota-trecho').value.trim();
            const obs = document.getElementById('nova-rota-obs').value.trim();

            if (!nome || !hierarquia) {
                alert('âš ï¸ Preencha o nome e a classificacao da rota!');
                return;
            }

            if (pontosDesenho.length < 2) {
                alert('âš ï¸ A rota precisa ter pelo menos 2 pontos!');
                return;
            }

            const cor = hierarquiaCores[hierarquia] || '#10b981';

            const novaRota = L.polyline(pontosDesenho, {
                color: cor,
                weight: hierarquia === 'Estrutural' ? 4 : 3,
                opacity: 0.8,
                interactive: true
            }).addTo(mobilidadeMap);

            novaRota.feature = {
                properties: {
                    name: nome,
                    Hierarquia: hierarquia,
                    Trecho: trecho || 'Toda extensao',
                    descricao: obs || ''
                }
            };

            novaRota._hierarquia = hierarquia;

            novaRota.on('click', function (e) {
                L.DomEvent.stopPropagation(e);
                showRotaModal(novaRota);
            });

            novaRota.on('mouseover', function () {
                this.setStyle({ color: '#fbbf24', weight: 5, opacity: 1 });
            });

            novaRota.on('mouseout', function () {
                if (selectedRotaLayer !== this) {
                    this.setStyle({
                        color: cor,
                        weight: hierarquia === 'Estrutural' ? 4 : 3,
                        opacity: 0.8
                    });
                }
            });

            if (!window.rotasClicaveis) window.rotasClicaveis = [];
            window.rotasClicaveis.push(novaRota);

            if (kmlLayer) kmlLayer.addLayer(novaRota);

            limparDesenhoTemporario();
            cancelarNovaRota();
            atualizarEstatisticas();

            // console.log('âœ… Nova rota adicionada:', nome);
            alert(`âœ… Rota "${nome}" adicionada com sucesso!`);
        }

        function cancelarNovaRota() {
            limparDesenhoTemporario();
            cancelarDesenho();

            document.getElementById('nova-rota-modal').classList.remove('active');
            document.getElementById('rota-origem').value = '';
            document.getElementById('rota-destino').value = '';
            document.getElementById('nova-rota-nome').value = '';
            document.getElementById('nova-rota-hierarquia').value = '';
            document.getElementById('nova-rota-trecho').value = '';
            document.getElementById('nova-rota-obs').value = '';
            document.getElementById('rota-info').style.display = 'none';
            document.getElementById('dados-rota').style.display = 'none';
            document.getElementById('btn-salvar-rota').style.display = 'none';

            coordOrigem = null;
            coordDestino = null;
            pontosDesenho = [];
        }

        function closeNovaRotaModal() {
            cancelarNovaRota();
        }

        // ===== FIM DO SISTEMA DE ROTEAMENTO =====

        // ===== ANALISE DE TRA‚NSITO EM ROTAS =====

        function analisarTransitoNaRota(layer) {
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ” ANALISANDO TRA‚NSITO NA ROTA');
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            // console.log('wazeMarkers existe?', !!wazeMarkers);
            // console.log('wazeMarkers.length:', wazeMarkers ? wazeMarkers.length : 0);
            // console.log('wazeVisible:', wazeVisible);

            if (!wazeMarkers || wazeMarkers.length === 0) {
                // console.log('âŒ Nenhum dado do Waze carregado');
                return null;
            }

            const latlngs = layer.getLatLngs();
            // console.log('Pontos da rota:', latlngs.length);

            if (!latlngs || latlngs.length === 0) {
                // console.log('âŒ Rota sem pontos');
                return null;
            }

            // Estatísticas
            const analise = {
                acidentes: 0,
                congestionamentos: 0,
                perigos: 0,
                outros: 0,
                velocidades: [],
                velocidadeMedia: null,
                nivelCongestionamento: 0,
                alertasProximos: [],
                distanciaTotal: 0
            };

            // Calcular distA¢ncia total da rota
            for (let i = 0; i < latlngs.length - 1; i++) {
                analise.distanciaTotal += mobilidadeMap.distance(latlngs[i], latlngs[i + 1]);
            }
            analise.distanciaTotal = (analise.distanciaTotal / 1000).toFixed(2);

            // console.log('ðŸ“ DistA¢ncia total da rota:', analise.distanciaTotal, 'km');

            // Raio de busca (200 metros)
            const raioMetros = 200;
            // console.log('ðŸŽ¯ Raio de busca:', raioMetros, 'metros');

            let marcadoresVerificados = 0;
            let marcadoresProximos = 0;

            // Verificar cada marcador do Waze
            wazeMarkers.forEach((marker, index) => {
                if (!marker || !marker.wazeData) {
                    console.log(`âš ï¸ Marcador ${index} sem dados`);
                    return;
                }

                marcadoresVerificados++;

                const markerLatLng = marker.getLatLng();
                let menorDistancia = Infinity;

                // Calcular distA¢ncia minima do marcador ate a rota
                latlngs.forEach(ponto => {
                    const distancia = mobilidadeMap.distance(markerLatLng, ponto);
                    if (distancia < menorDistancia) {
                        menorDistancia = distancia;
                    }
                });

                // Se estiver proximo
                if (menorDistancia <= raioMetros) {
                    marcadoresProximos++;

                    const data = marker.wazeData;
                    const tipo = data.tipo || data.type || '';

                    console.log(`âœ… [${marcadoresProximos}] Alerta proximo:`, tipo, `(${Math.round(menorDistancia)}m)`);

                    // Contar por tipo
                    if (tipo.includes('Acidente') || tipo === 'ACCIDENT') {
                        analise.acidentes++;
                    } else if (tipo.includes('Congestionamento') || tipo === 'JAM') {
                        analise.congestionamentos++;

                        if (data.velocidade !== undefined) {
                            analise.velocidades.push(data.velocidade);
                            // console.log('  ðŸ“Š Velocidade:', data.velocidade, 'km/h');
                        }

                        if (data.nivel !== undefined) {
                            analise.nivelCongestionamento += data.nivel;
                            // console.log('  ðŸš¦ Nivel:', data.nivel);
                        }
                    } else if (tipo.includes('Perigo') || tipo === 'HAZARD' || tipo === 'WEATHERHAZARD' || tipo === 'ROAD_CLOSED') {
                        analise.perigos++;
                    } else {
                        analise.outros++;
                    }

                    // Guardar alerta
                    analise.alertasProximos.push({
                        tipo: data.titulo,
                        icone: data.icone,
                        cor: data.cor,
                        rua: data.rua || data.street || 'Via nao identificada',
                        distancia: Math.round(menorDistancia)
                    });
                }
            });

            // console.log('ðŸ“Š Marcadores verificados:', marcadoresVerificados);
            // console.log('ðŸ“ Marcadores proximos:', marcadoresProximos);

            // Calcular velocidade media
            if (analise.velocidades.length > 0) {
                const soma = analise.velocidades.reduce((a, b) => a + b, 0);
                analise.velocidadeMedia = Math.round((soma / analise.velocidades.length) * 10) / 10;
                // console.log('ðŸš— Velocidade media:', analise.velocidadeMedia, 'km/h');
            }

            // Calcular nivel medio
            if (analise.congestionamentos > 0) {
                analise.nivelCongestionamento = Math.round(analise.nivelCongestionamento / analise.congestionamentos);
            }

            analise.totalAlertas = analise.acidentes + analise.congestionamentos + analise.perigos + analise.outros;

            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            // console.log('ðŸ“Š RESUMO DA ANALISE:');
            // console.log('   Total de alertas:', analise.totalAlertas);
            // console.log('   ðŸš¨ Acidentes:', analise.acidentes);
            // console.log('   ðŸš— Congestionamentos:', analise.congestionamentos);
            // console.log('   âš ï¸ Perigos:', analise.perigos);
            // console.log('   ðŸ“ Outros:', analise.outros);
            // console.log('   ðŸš™ Velocidade media:', analise.velocidadeMedia);
            // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            return analise;
        }

        function getStatusTransito(analise) {
            if (!analise || analise.totalAlertas === 0) {
                return {
                    nivel: 0,
                    texto: 'Sem InformacAµes',
                    cor: '#64748b',
                    icone: 'â“',
                    badge: 'info'
                };
            }

            // Baseado em velocidade media
            if (analise.velocidadeMedia !== null) {
                if (analise.velocidadeMedia < 10) {
                    return {
                        nivel: 4,
                        texto: 'Transito Parado',
                        cor: '#dc2626',
                        icone: 'ðŸš«',
                        badge: 'danger'
                    };
                } else if (analise.velocidadeMedia < 20) {
                    return {
                        nivel: 3,
                        texto: 'Transito Intenso',
                        cor: '#ef4444',
                        icone: 'ðŸš—',
                        badge: 'danger'
                    };
                } else if (analise.velocidadeMedia < 40) {
                    return {
                        nivel: 2,
                        texto: 'Transito Moderado',
                        cor: '#f59e0b',
                        icone: 'ðŸš™',
                        badge: 'warning'
                    };
                } else {
                    return {
                        nivel: 1,
                        texto: 'Transito Fluindo',
                        cor: '#10b981',
                        icone: 'âœ…',
                        badge: 'success'
                    };
                }
            }

            // Baseado em congestionamentos
            if (analise.congestionamentos >= 3) {
                return {
                    nivel: 3,
                    texto: 'Transito Intenso',
                    cor: '#ef4444',
                    icone: 'ðŸš—',
                    badge: 'danger'
                };
            } else if (analise.congestionamentos >= 1) {
                return {
                    nivel: 2,
                    texto: 'Transito Moderado',
                    cor: '#f59e0b',
                    icone: 'ðŸš™',
                    badge: 'warning'
                };
            }

            // Baseado em acidentes
            if (analise.acidentes >= 1) {
                return {
                    nivel: 3,
                    texto: 'Atencao - Acidente',
                    cor: '#ef4444',
                    icone: 'ðŸš¨',
                    badge: 'danger'
                };
            }

            return {
                nivel: 1,
                texto: 'Transito Normal',
                cor: '#10b981',
                icone: 'âœ…',
                badge: 'success'
            };
        }

        // ===== CARREGAR APIs =====
        async function loadTransitoStatus() {
            try {
                const response = await fetch('/api/transito-status/');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('transito-container');
                    const status = data.data;

                    const statusHTML = `
                        <div class="transito-status nivel-${status.nivel}">
                            <div class="transito-icon" style="background: ${status.cor}20; color: ${status.cor};">
                                <i class="bi bi-car-front-fill"></i>
                            </div>
                            <div class="transito-descricao" style="color: ${status.cor};">
                                ${status.descricao}
                            </div>
                            <div class="transito-detalhes">
                                <div class="transito-detail">
                                    <div class="transito-detail-value">${status.lentidao_km} km</div>
                                    <div class="transito-detail-label">Lentidao</div>
                                </div>
                                <div class="transito-detail">
                                    <div class="transito-detail-value">${status.velocidade_media} km/h</div>
                                    <div class="transito-detail-label">Velocidade Media</div>
                                </div>
                                <div class="transito-detail">
                                    <div class="transito-detail-value">${status.hora}h</div>
                                    <div class="transito-detail-label">Hora Atual</div>
                                </div>
                            </div>
                        </div>
                    `;

                    container.innerHTML = statusHTML;
                    document.getElementById('transito-nivel').textContent = status.descricao.replace('Transito ', '');
                }
            } catch (error) {
                console.error('Erro ao carregar status:', error);
            }
        }

        async function loadBRT() {
            try {
                const response = await fetch('/api/brt/');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('brt-container');
                    container.innerHTML = '';

                    data.data.forEach(linha => {
                        const card = `
                            <div class="linha-card" style="--linha-cor: ${linha.cor}">
                                <div class="linha-header">
                                    <div class="linha-nome">${linha.nome}</div>
                                    <span class="linha-status ${linha.status_code}">${linha.status}</span>
                                </div>
                                <div class="linha-info">
                                    <div class="linha-info-item">
                                        EstacAµes
                                        <strong>${linha.estacoes}</strong>
                                    </div>
                                    <div class="linha-info-item">
                                        Extensao
                                        <strong>${linha.extensao}</strong>
                                    </div>
                                    <div class="linha-info-item">
                                        Tempo Medio
                                        <strong>${linha.tempo_medio}</strong>
                                    </div>
                                    <div class="linha-info-item">
                                        Intervalo
                                        <strong>${linha.intervalo}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += card;
                    });

                    document.getElementById('brt-total').textContent = data.count;
                }
            } catch (error) {
                console.error('Erro ao carregar BRT:', error);
            }
        }

        async function loadMetro() {
            try {
                const response = await fetch('/api/metro/');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('metro-container');
                    container.innerHTML = '';

                    data.data.forEach(linha => {
                        const card = `
                            <div class="linha-card" style="--linha-cor: ${linha.cor}">
                                <div class="linha-header">
                                    <div class="linha-nome">${linha.nome}</div>
                                    <span class="linha-status ${linha.status_code}">${linha.status}</span>
                                </div>
                                <div class="linha-info">
                                    <div class="linha-info-item">
                                        EstacAµes
                                        <strong>${linha.estacoes}</strong>
                                    </div>
                                    <div class="linha-info-item">
                                        Extensao
                                        <strong>${linha.extensao}</strong>
                                    </div>
                                    <div class="linha-info-item">
                                        Intervalo
                                        <strong>${linha.intervalo}</strong>
                                    </div>
                                    <div class="linha-info-item">
                                        Trecho
                                        <strong>${linha.origem} - ${linha.destino}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += card;
                    });

                    document.getElementById('metro-total').textContent = data.count;
                }
            } catch (error) {
                console.error('Erro ao carregar MetrA´:', error);
            }
        }

        async function loadBikeRio() {
            try {
                const response = await fetch('/api/bike-rio/');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('bike-container');
                    container.innerHTML = '';

                    data.data.forEach(estacao => {
                        const statusClass = estacao.bikes_disponiveis === 0 ? 'sem-bikes' : '';
                        const statusText = estacao.bikes_disponiveis === 0 ? 'Sem Bikes' : estacao.status;

                        const card = `
                            <div class="bike-card">
                                <div class="bike-header">
                                    <div class="bike-nome">
                                        <i class="bi bi-bicycle"></i> ${estacao.nome}
                                    </div>
                                    <span class="bike-status ${statusClass}">${statusText}</span>
                                </div>
                                <div class="bike-stats">
                                    <div class="bike-stat">
                                        <div class="bike-stat-value">${estacao.bikes_disponiveis}</div>
                                        <div class="bike-stat-label">Bikes</div>
                                    </div>
                                    <div class="bike-stat">
                                        <div class="bike-stat-value">${estacao.vagas_disponiveis}</div>
                                        <div class="bike-stat-label">Vagas</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += card;
                    });

                    document.getElementById('bike-total').textContent = data.total_bikes;
                }
            } catch (error) {
                console.error('Erro ao carregar Bike Rio:', error);
            }
        }

        // Dropdown toggle
        document.querySelectorAll('.cor-menu-item').forEach(item => {
            item.addEventListener('click', function (e) {
                if (this.querySelector('.cor-submenu')) {
                    e.preventDefault();
                    this.classList.toggle('open');

                    document.querySelectorAll('.cor-menu-item').forEach(other => {
                        if (other !== this) other.classList.remove('open');
                    });
                }
            });
        });

        function mostrarModoAutomatico() {
            // console.log('ðŸ”„ Modo automatico');

            modoAtual = 'automatico';

            document.getElementById('tab-automatico').classList.add('active');
            document.getElementById('tab-manual').classList.remove('active');

            const modoAuto = document.getElementById('modo-automatico');
            const modoManual = document.getElementById('modo-manual');

            modoAuto.classList.add('active');
            modoAuto.style.display = 'block';

            modoManual.classList.remove('active');
            modoManual.style.display = 'none';
        }

        function mostrarModoManual() {
            // console.log('ðŸ”„ Modo manual');

            modoAtual = 'manual';

            document.getElementById('tab-manual').classList.add('active');
            document.getElementById('tab-automatico').classList.remove('active');

            const modoAuto = document.getElementById('modo-automatico');
            const modoManual = document.getElementById('modo-manual');

            modoManual.classList.add('active');
            modoManual.style.display = 'block';

            modoAuto.classList.remove('active');
            modoAuto.style.display = 'none';
        }


        // ===== FUNA‡A•ES DO MODAL DE ALERTA WAZE =====

        function showWazeModal(marker) {
            selectedWazeMarker = marker;

            const data = marker.wazeData;

            document.getElementById('waze-modal-title').innerHTML =
                `${data.icone} ${data.titulo}`;

            let content = '';

            // ===== HERO SECTION =====
            const rua = data.rua || data.street || 'Via nao identificada';
            const cidade = data.cidade || data.city || 'Rio de Janeiro';
            const subtipo = data.subtipo || data.subtype || data.nivel_texto || '';

            content += `
                <div class="waze-hero">
                    <div class="waze-hero-icon">${data.icone}</div>
                    <div class="waze-hero-title">${data.titulo}</div>
                    ${subtipo ? `<div class="waze-hero-subtitle">${subtipo}</div>` : ''}
                </div>
            `;

            // ===== LOCALIZAA‡AƒO =====
            content += `
                <div class="waze-modal-section">
                    <div class="waze-section-title">
                        <i class="bi bi-geo-alt-fill"></i>
                        Localizacao
                    </div>
                    
                    <div class="waze-info-row">
                        <div class="waze-info-icon">ðŸ“</div>
                        <div class="waze-info-content">
                            <div class="waze-info-label">Endereco</div>
                            <div class="waze-info-value">${rua}</div>
                        </div>
                    </div>
                    
                    <div class="waze-info-row">
                        <div class="waze-info-icon">ðŸ™ï¸</div>
                        <div class="waze-info-content">
                            <div class="waze-info-label">Cidade</div>
                            <div class="waze-info-value">${cidade}</div>
                        </div>
                    </div>
                </div>
            `;

            // ===== DESCRIA‡AƒO (se existir) =====
            const descricao = data.reportDescription || data.descricao;
            if (descricao && descricao.trim() !== '') {
                content += `
                    <div class="waze-modal-section">
                        <div class="waze-section-title">
                            <i class="bi bi-chat-left-text-fill"></i>
                            descricao
                        </div>
                        <div class="waze-info-row">
                            <div class="waze-info-icon">ðŸ’¬</div>
                            <div class="waze-info-content">
                                <div class="waze-info-value">${descricao}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ===== ESTATASTICAS (para congestionamentos) =====
            const hasStats = data.velocidade !== undefined ||
                data.comprimento !== undefined ||
                data.atraso !== undefined ||
                data.nivel !== undefined;

            if (hasStats) {
                content += `
                    <div class="waze-modal-section">
                        <div class="waze-section-title">
                            <i class="bi bi-speedometer2"></i>
                            Estatísticas do Transito
                        </div>
                        <div class="waze-stats-grid">
                `;

                // Velocidade
                if (data.velocidade !== undefined) {
                    const velocidade = Math.round(data.velocidade * 10) / 10;
                    let badgeClass = 'success';
                    let statusText = 'Fluindo';

                    if (velocidade < 10) {
                        badgeClass = 'danger';
                        statusText = 'Parado';
                    } else if (velocidade < 20) {
                        badgeClass = 'warning';
                        statusText = 'Muito Lento';
                    } else if (velocidade < 40) {
                        badgeClass = 'info';
                        statusText = 'Lento';
                    }

                    content += `
                        <div class="waze-stat-box">
                            <div class="waze-badge ${badgeClass}" style="margin-bottom: 8px; font-size: 10px;">
                                ${statusText}
                            </div>
                            <div class="waze-stat-value" style="color: ${data.cor};">${velocidade}</div>
                            <div class="waze-stat-label">km/h</div>
                        </div>
                    `;
                }

                // Comprimento
                if (data.comprimento !== undefined) {
                    const comprimento = Math.round(data.comprimento);
                    content += `
                        <div class="waze-stat-box">
                            <div class="waze-stat-value" style="color: ${data.cor};">${comprimento}</div>
                            <div class="waze-stat-label">Metros</div>
                        </div>
                    `;
                }

                // Atraso
                if (data.atraso !== undefined) {
                    const atrasoMin = Math.round(data.atraso / 60);
                    content += `
                        <div class="waze-stat-box">
                            <div class="waze-stat-value" style="color: ${data.cor};">${atrasoMin}</div>
                            <div class="waze-stat-label">Min Atraso</div>
                        </div>
                    `;
                }

                // Nivel
                if (data.nivel !== undefined) {
                    const niveis = ['Livre', 'Leve', 'Moderado', 'Pesado', 'Parado', 'Muito Lento'];
                    content += `
                        <div class="waze-stat-box">
                            <div class="waze-stat-value" style="color: ${data.cor};">${data.nivel}</div>
                            <div class="waze-stat-label">${niveis[data.nivel] || 'N/A'}</div>
                        </div>
                    `;
                }

                content += `
                        </div>
                    </div>
                `;
            }

            // ===== CONFIABILIDADE =====
            const confianca = data.confianca || data.confidence;
            const confiabilidade = data.confiabilidade || data.reliability;

            if (confianca !== undefined || confiabilidade !== undefined) {
                content += `
                    <div class="waze-modal-section">
                        <div class="waze-section-title">
                            <i class="bi bi-shield-check"></i>
                            Confiabilidade
                        </div>
                        <div class="waze-stats-grid" style="grid-template-columns: 1fr 1fr;">
                `;

                if (confianca !== undefined) {
                    content += `
                        <div class="waze-stat-box">
                            <div class="waze-stat-value" style="color: #10b981;">${confianca}</div>
                            <div class="waze-stat-label">â­ Confianca</div>
                        </div>
                    `;
                }

                if (confiabilidade !== undefined) {
                    content += `
                        <div class="waze-stat-box">
                            <div class="waze-stat-value" style="color: #10b981;">${confiabilidade}</div>
                            <div class="waze-stat-label">ðŸŽ¯ Qualidade</div>
                        </div>
                    `;
                }

                content += `
                        </div>
                    </div>
                `;
            }

            // ===== FONTE =====
            content += `
                <div class="waze-modal-section">
                    <div class="waze-source">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Waze_logo.svg/200px-Waze_logo.svg.png" alt="Waze">
                        <div class="waze-source-text">
                            <strong>Dados em tempo real</strong><br>
                            InformacAµes coletadas pela comunidade Waze
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('waze-modal-body').innerHTML = content;
            document.getElementById('waze-modal').classList.add('active');
        }

        function closeWazeModal() {
            document.getElementById('waze-modal').classList.remove('active');

            if (selectedWazeMarker) {
                selectedWazeMarker._icon.style.transform = 'scale(1)';
                selectedWazeMarker._icon.style.zIndex = '1000';
                selectedWazeMarker = null;
            }
        }

        function centerWazeOnMap() {
            if (selectedWazeMarker) {
                const latlng = selectedWazeMarker.getLatLng();
                mobilidadeMap.setView(latlng, 16, {
                    animate: true,
                    duration: 1
                });
            }
        }

        // Fechar modal ao clicar fora
        document.addEventListener('click', function (e) {
            const modal = document.getElementById('waze-modal');
            if (e.target === modal) {
                closeWazeModal();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeWazeModal();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            initMapa();
            loadTransitoStatus();
            loadBRT();
            loadMetro();
            loadBikeRio();

            // âœ… CARREGAR ROTAS SALVAS APA“S O MAPA INICIAR
            setTimeout(() => {
                carregarRotasSalvas();
            }, 2000); // Aguardar 2 segundos para garantir que o mapa esta pronto

            // ===== CONFIGURAR BOTAƒO DE DESENHO COM CAPTURE =====
            const configurarBotaoDesenho = () => {
                const btnDesenho = document.getElementById('btn-iniciar-desenho-manual');

                if (btnDesenho && !btnDesenho.hasAttribute('data-configured')) {
                    btnDesenho.setAttribute('data-configured', 'true');

                    // console.log('ðŸ”§ Configurando botao de desenho...');

                    // Usar addEventListener COM CAPTURE para interceptar ANTES
                    btnDesenho.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        // console.log('ðŸ–±ï¸ BOTAƒO CLICADO!');
                        // console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                        // Fechar modal
                        const modal = document.getElementById('nova-rota-modal');
                        modal.classList.remove('active');
                        modal.style.display = 'none';

                        // console.log('âœ… Modal fechado');

                        // Chamar desenho
                        setTimeout(() => {
                            // console.log('ðŸŽ¨ Iniciando desenho...');
                            iniciarDesenhoManual();
                        }, 300);

                        return false;
                    }, true); // âœ… CAPTURE = TRUE (MUITO IMPORTANTE!)

                    // console.log('âœ… Botao configurado com CAPTURE!');
                }
            };

            // Configurar agora
            setTimeout(configurarBotaoDesenho, 500);

            // Configurar sempre que o modal abrir
            const modal = document.getElementById('nova-rota-modal');
            const observer = new MutationObserver(() => {
                if (modal.classList.contains('active')) {
                    setTimeout(configurarBotaoDesenho, 100);
                }
            });

            observer.observe(modal, {
                attributes: true,
                attributeFilter: ['class']
            });

            // console.log('âœ… Observer configurado');

            setInterval(() => {
                loadTransitoStatus();
                loadBikeRio();
            }, 2 * 60 * 1000);

            // console.log('âœ… Dashboard de Mobilidade inicializado');
        });


        // ===== FUNA‡A•ES DO MODAL DE ALERTA WAZE =====

        function showWazeModal(marker) {
            selectedWazeMarker = marker;

            // Destacar marcador selecionado
            marker._icon.style.transform = 'scale(1.3)';
            marker._icon.style.zIndex = '10001';

            const data = marker.wazeData;

            document.getElementById('waze-modal-title').innerHTML =
                `${data.icone} ${data.titulo}`;

            // Montar conteudo do modal
            let content = '';

            // ===== INFORMAA‡A•ES PRINCIPAIS =====
            if (data.rua || data.street) {
                content += `
                    <div class="rota-info-item">
                        <div class="rota-info-label">
                            <i class="bi bi-signpost-2-fill"></i>
                            Local
                        </div>
                        <div class="rota-info-value" style="font-size: 18px; font-weight: 600;">
                            ðŸ“ ${data.rua || data.street}
                        </div>
                    </div>
                `;
            }

            if (data.cidade || data.city) {
                content += `
                    <div class="rota-info-item">
                        <div class="rota-info-label">
                            <i class="bi bi-buildings-fill"></i>
                            Cidade
                        </div>
                        <div class="rota-info-value">
                            ðŸ™ï¸ ${data.cidade || data.city}
                        </div>
                    </div>
                `;
            }

            // ===== TIPO E SUBTIPO =====
            const subtipo = data.subtipo || data.subtype || data.nivel_texto;
            if (subtipo) {
                content += `
                    <div class="rota-info-item" style="border-left: 4px solid ${data.cor};">
                        <div class="rota-info-label">
                            <i class="bi bi-tag-fill" style="color: ${data.cor};"></i>
                            Classificacao
                        </div>
                        <div class="rota-info-value" style="color: ${data.cor}; font-weight: 600;">
                            ${subtipo}
                        </div>
                    </div>
                `;
            }

            // ===== DESCRIA‡AƒO =====
            const descricao = data.reportDescription || data.descricao;
            if (descricao) {
                content += `
                    <div class="rota-info-item">
                        <div class="rota-info-label">
                            <i class="bi bi-chat-left-text-fill"></i>
                            descricao
                        </div>
                        <div class="rota-info-value">
                            ${descricao}
                        </div>
                    </div>
                `;
            }

            // ===== ESTATASTICAS (para congestionamentos) =====
            const stats = [];

            if (data.velocidade !== undefined) {
                const velocidade = Math.round(data.velocidade * 10) / 10;
                let statusVelocidade = '';
                let iconeVelocidade = '';

                if (velocidade < 10) {
                    statusVelocidade = 'ðŸš— Parado';
                } else if (velocidade < 20) {
                    statusVelocidade = 'ðŸŒ Muito Lento';
                } else if (velocidade < 40) {
                    statusVelocidade = 'ðŸš™ Lento';
                } else {
                    statusVelocidade = 'âœ… Fluindo';
                }

                stats.push(`
                    <div class="rota-stat-card" style="border-color: ${data.cor};">
                        <div style="font-size: 14px; color: #94a3b8; margin-bottom: 4px;">
                            ${statusVelocidade}
                        </div>
                        <div class="rota-stat-value" style="color: ${data.cor};">${velocidade}</div>
                        <div class="rota-stat-label">km/h</div>
                    </div>
                `);
            }

            if (data.comprimento !== undefined) {
                const comprimento = Math.round(data.comprimento);
                stats.push(`
                    <div class="rota-stat-card" style="border-color: ${data.cor};">
                        <div class="rota-stat-value" style="color: ${data.cor};">${comprimento}</div>
                        <div class="rota-stat-label">ðŸ“ Metros de Extensao</div>
                    </div>
                `);
            }

            if (data.atraso !== undefined) {
                const atrasoMin = Math.round(data.atraso / 60);
                stats.push(`
                    <div class="rota-stat-card" style="border-color: ${data.cor};">
                        <div class="rota-stat-value" style="color: ${data.cor};">${atrasoMin}</div>
                        <div class="rota-stat-label">â±ï¸ Minutos de Atraso</div>
                    </div>
                `);
            }

            if (data.nivel !== undefined) {
                const niveis = ['Livre', 'Leve', 'Moderado', 'Pesado', 'Parado', 'Muito Lento'];
                stats.push(`
                    <div class="rota-stat-card" style="border-color: ${data.cor};">
                        <div class="rota-stat-value" style="color: ${data.cor};">${data.nivel}</div>
                        <div class="rota-stat-label">ðŸš¦ Nivel (${niveis[data.nivel] || 'N/A'})</div>
                    </div>
                `);
            }

            // Confiabilidade
            if (data.confianca !== undefined || data.confidence !== undefined) {
                const confianca = data.confianca || data.confidence || 0;
                stats.push(`
                    <div class="rota-stat-card" style="border-color: ${data.cor};">
                        <div class="rota-stat-value" style="color: ${data.cor};">${confianca}</div>
                        <div class="rota-stat-label">â­ Confianca</div>
                    </div>
                `);
            }

            if (stats.length > 0) {
                content += `
                    <div class="rota-stats" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                        ${stats.join('')}
                    </div>
                `;
            }

            // ===== INFORMAA‡A•ES ADICIONAIS =====
            content += `
                <div class="rota-info-item" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
                    <div class="rota-info-label">
                        <i class="bi bi-info-circle-fill" style="color: #3b82f6;"></i>
                        Fonte
                    </div>
                    <div class="rota-info-value">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Waze_logo.svg/200px-Waze_logo.svg.png" 
                             alt="Waze" 
                             style="height: 20px; vertical-align: middle; margin-right: 8px;">
                        Dados em tempo real da comunidade Waze
                    </div>
                </div>
            `;

            document.getElementById('waze-modal-body').innerHTML = content;
            document.getElementById('waze-modal').classList.add('active');
        }

        function closeWazeModal() {
            document.getElementById('waze-modal').classList.remove('active');

            if (selectedWazeMarker) {
                selectedWazeMarker._icon.style.transform = 'scale(1)';
                selectedWazeMarker._icon.style.zIndex = '1000';
                selectedWazeMarker = null;
            }
        }

        function centerWazeOnMap() {
            if (selectedWazeMarker) {
                const latlng = selectedWazeMarker.getLatLng();
                mobilidadeMap.setView(latlng, 16, {
                    animate: true,
                    duration: 1
                });
            }
        }

        // Fechar modal ao clicar fora
        document.addEventListener('click', function (e) {
            const modal = document.getElementById('waze-modal');
            if (e.target === modal) {
                closeWazeModal();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeWazeModal();
            }
        });

    </script>

    <!-- Modal de Nova Rota -->
    <div class="nova-rota-modal" id="nova-rota-modal">
        <div class="nova-rota-content" style="max-width: 600px;">
            <div class="nova-rota-header">
                <h3>
                    <i class="bi bi-plus-circle-fill"></i>
                    Nova Rota
                </h3>
                <button class="rota-modal-close" onclick="closeNovaRotaModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="nova-rota-body">

                <!-- Abas de Modo -->
                <div
                    style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                    <button class="modo-tab active" onclick="mudarModo('automatico')" id="tab-automatico">
                        <i class="bi bi-magic"></i> Roteamento Automatico
                    </button>
                    <button class="modo-tab" onclick="mudarModo('manual')" id="tab-manual">
                        <i class="bi bi-pencil"></i> Desenho Manual
                    </button>
                </div>

                <!-- Modo Automatico -->
                <div id="modo-automatico" class="modo-content active" style="display: block;">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-geo-alt-fill" style="color: #10b981;"></i>
                            Ponto Inicial *
                        </label>
                        <input type="text" id="rota-origem" class="form-input"
                            placeholder="Ex: Copacabana, Rio de Janeiro"
                            onkeydown="if(event.key==='Enter') buscarEndereco('origem')">
                        <button class="search-btn" onclick="buscarEndereco('origem')">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-flag-fill" style="color: #ef4444;"></i>
                            Ponto Final *
                        </label>
                        <input type="text" id="rota-destino" class="form-input"
                            placeholder="Ex: Ipanema, Rio de Janeiro"
                            onkeydown="if(event.key==='Enter') buscarEndereco('destino')">
                        <button class="search-btn" onclick="buscarEndereco('destino')">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>

                    <button class="btn-calcular-rota" onclick="calcularRotaAutomatica()">
                        <i class="bi bi-arrow-left-right"></i>
                        Calcular Rota
                    </button>

                    <div id="rota-info"
                        style="display: none; margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px;">
                        <div style="color: #10b981; font-weight: 600; margin-bottom: 8px;">
                            <i class="bi bi-check-circle-fill"></i> Rota Calculada
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 13px; color: #cbd5e1;">
                            <span><strong>DistA¢ncia:</strong> <span id="rota-distancia">-</span></span>
                            <span><strong>Tempo:</strong> <span id="rota-tempo">-</span></span>
                        </div>
                    </div>
                </div>

                <!-- Modo Manual -->
                <div id="modo-manual" class="modo-content" style="display: none;">
                    <div
                        style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.1) 100%); border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="color: #f59e0b; font-weight: 700; margin-bottom: 12px; font-size: 16px;">
                            <i class="bi bi-info-circle-fill"></i> Como funciona
                        </div>
                        <ul style="font-size: 14px; color: #cbd5e1; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Clique</strong> no mapa para adicionar pontos-chave numerados</li>
                            <li><strong>Arraste</strong> os pontos vermelhos para reposicionar</li>
                            <li><strong>Duplo-clique</strong> em um ponto para removAª-lo</li>
                            <li>A rota <strong style="color: #10b981;">verde</strong> e recalculada automaticamente
                                seguindo as vias</li>


                            <li>Use <strong>"Desfazer"</strong> para remover pontos</li>
                            <li>Clique em <strong>"Finalizar Rota"</strong> quando terminar</li>
                        </ul>
                    </div>

                    <div style="text-align: center; padding: 30px 20px; position: relative; z-index: 100;">
                        <button class="btn-iniciar-desenho" id="btn-iniciar-desenho-manual">
                            <i class="bi bi-pencil-fill"></i>
                            <span>Iniciar Desenho no Mapa</span>
                        </button>
                        <div style="color: #64748b; font-size: 12px; margin-top: 12px;">
                            O modal sera fechado e vocAª podera desenhar no mapa
                        </div>
                    </div>
                </div>

                <!-- Dados da Rota (comum para ambos) -->
                <div id="dados-rota" style="display: none;">
                    <hr style="border: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

                    <div class="form-group">
                        <label class="form-label">Nome da Via *</label>
                        <input type="text" id="nova-rota-nome" class="form-input" placeholder="Ex: Avenida AtlA¢ntica"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Classificacao Viaria *</label>
                        <select id="nova-rota-hierarquia" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="Estrutural">Estrutural</option>
                            <option value="Arterial primaria">Arterial Primaria</option>
                            <option value="Arterial secundaria">Arterial Secundaria</option>
                            <option value="Coletora">Coletora</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Trecho (Opcional)</label>
                        <input type="text" id="nova-rota-trecho" class="form-input"
                            placeholder="Ex: Copacabana ate Ipanema">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ObservacAµes</label>
                        <textarea id="nova-rota-obs" class="form-input" rows="3"
                            placeholder="InformacAµes adicionais..."></textarea>
                    </div>
                </div>
            </div>

            <div class="nova-rota-footer">
                <button class="nova-rota-btn secondary" onclick="cancelarNovaRota()">
                    <i class="bi bi-x-circle"></i>
                    Cancelar
                </button>
                <button class="nova-rota-btn primary" id="btn-salvar-rota" onclick="salvarNovaRota()"
                    style="display: none;">
                    <i class="bi bi-check-circle-fill"></i>
                    Salvar Rota
                </button>
            </div>
        </div>
    </div>


    <!-- ========================================
     🌙 SISTEMA DE TEMA CLARO/ESCURO
     ======================================== -->
    <script>
        (function () {
            // console.log('🎨 Inicializando Sistema de Temas COR...');

            let currentTheme = localStorage.getItem('cor-theme') || 'light';

            // Aplicar tema imediatamente
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-theme');
            }

            function applyTheme(theme) {
                currentTheme = theme;

                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                    updateThemeButton('sun', 'Tema Claro');
                    // console.log('🌙 Tema escuro ativado');
                } else {
                    document.body.classList.remove('dark-theme');
                    updateThemeButton('moon', 'Tema Escuro');
                    // console.log('☀️ Tema claro ativado');
                }

                localStorage.setItem('cor-theme', theme);
            }

            function toggleTheme() {
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            }

            function updateThemeButton(icon, tooltip) {
                const button = document.getElementById('theme-toggle');
                if (!button) return;

                const iconElement = button.querySelector('i');
                const spanElement = button.querySelector('span');

                if (iconElement) {
                    iconElement.className = `bi bi-${icon}-fill`;
                }

                if (spanElement) {
                    spanElement.textContent = tooltip;
                }

                button.setAttribute('title', tooltip);
            }

            function init() {
                const themeButton = document.getElementById('theme-toggle');

                if (themeButton) {
                    themeButton.addEventListener('click', toggleTheme);
                    applyTheme(currentTheme);
                    // console.log('✅ Botío de tema conectado!');
                } else {
                    console.warn('⚠️ Botío #theme-toggle nío encontrado');
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>

</html>