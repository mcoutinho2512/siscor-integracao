from django.shortcuts import render
from django.http import JsonResponse, HttpResponse
from django.views.decorators.cache import never_cache, cache_page
from django.views.decorators.csrf import csrf_exempt
from rest_framework.decorators import api_view
from rest_framework.response import Response
from datetime import datetime
from aplicativo.models import (
    Sirene, DadosSirene, 
    Estagio, 
    ChuvaConsolidado,
    Evento,
    Ocorrencias
)

# ============================================
# VIEWS DE PÃGINAS
# ============================================

def waze_dashboard_view(request):
    """Dashboard principal do mapa"""
    return render(request, 'mapa_novo/waze_dashboard.html')


# ============================================
# APIs - SIRENES
# ============================================

@never_cache
def sirene_api(request):
    """
    API de Sirenes - Retorna todas as sirenes com seus Ãºltimos dados
    """
    try:
        lista_estacoes = []
        sirenes = Sirene.objects.all()
        
        for sirene in sirenes:
            try:
                # Pegar Ãºltimo dado da sirene
                dados = DadosSirene.objects.filter(estacao_id=sirene.id).latest('id')
                
                lista_estacoes.append({
                    "id": sirene.id,
                    "fonte": sirene.fonte if hasattr(sirene, 'fonte') else "COR",
                    "lat": float(sirene.lat) if sirene.lat else -22.9068,
                    "lng": float(sirene.lon) if sirene.lon else -43.1729,
                    "nome": sirene.nome,
                    "cidade": sirene.municipio if hasattr(sirene, 'municipio') else "Rio de Janeiro",
                    "status": dados.status if hasattr(dados, 'status') else "ativa",
                    "tipo": dados.tipo if hasattr(dados, 'tipo') else "alta",
                    "prioridade": dados.tipo if hasattr(dados, 'tipo') else "alta"
                })
            except DadosSirene.DoesNotExist:
                # Se nÃ£o tem dados, adiciona com valores padrÃ£o
                lista_estacoes.append({
                    "id": sirene.id,
                    "fonte": sirene.fonte if hasattr(sirene, 'fonte') else "COR",
                    "lat": float(sirene.lat) if sirene.lat else -22.9068,
                    "lng": float(sirene.lon) if sirene.lon else -43.1729,
                    "nome": sirene.nome,
                    "cidade": sirene.municipio if hasattr(sirene, 'municipio') else "Rio de Janeiro",
                    "status": "inativa",
                    "tipo": "baixa",
                    "prioridade": "baixa"
                })
        
        # Ordenar por tipo (prioridade)
        lista_ordenada = sorted(lista_estacoes, key=lambda k: k['tipo'], reverse=True)
        
        return JsonResponse({
            'success': True,
            'count': len(lista_ordenada),
            'data': lista_ordenada
        })
        
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e),
            'data': []
        }, status=500)


# ============================================
# APIs - ESTÃGIOS DE MOBILIDADE
# ============================================

@never_cache
def estagio_api(request):
    """
    API de EstÃ¡gios de Mobilidade
    Retorna o estÃ¡gio atual da cidade
    """
    try:
        av = Estagio.objects.latest('id')
        
        # Mapeamento de estÃ¡gios
        estagio_map = {
            "Normalidade": {"id": 1, "color": "#94c842", "nome": "Normalidade"},
            "MobilizaÃ§Ã£o": {"id": 2, "color": "#b1b1b3", "nome": "MobilizaÃ§Ã£o"},
            "AtenÃ§Ã£o": {"id": 3, "color": "#f7ce12", "nome": "AtenÃ§Ã£o"},
            "Alerta": {"id": 4, "color": "#d72d2e", "nome": "Alerta"},
            "Crise": {"id": 5, "color": "#a155a0", "nome": "Crise"}
        }
        
        estagio_nome = av.esta
        estagio_info = estagio_map.get(estagio_nome, estagio_map["Normalidade"])
        
        return JsonResponse({
            'success': True,
            'estagio': estagio_nome,
            'estagio_id': estagio_info['id'],
            'cor': estagio_info['color'],
            'mensagem': av.geo if hasattr(av, 'geo') else '',
            'inicio': av.data_i.isoformat() if hasattr(av, 'data_i') and av.data_i else None,
            'data_atualizacao': datetime.now().isoformat()
        })
        
    except Estagio.DoesNotExist:
        return JsonResponse({
            'success': True,
            'estagio': 'Normalidade',
            'estagio_id': 1,
            'cor': '#94c842',
            'mensagem': 'Sistema operando normalmente',
            'inicio': None,
            'data_atualizacao': datetime.now().isoformat()
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)


@csrf_exempt
def estagio_api_app(request):
    """API de estÃ¡gio para app mobile (formato simplificado)"""
    try:
        av = Estagio.objects.latest('id')
        estagio = av.esta.upper()
        return HttpResponse(estagio)
    except:
        return HttpResponse("NORMALIDADE")


# ============================================
# APIs - CHUVA/METEOROLOGIA
# ============================================

@cache_page(60 * 5)  # Cache de 5 minutos
def chuva_api(request):
    """
    API de Dados de Chuva
    Retorna Ãºltimo consolidado de chuva
    """
    try:
        consolidado = ChuvaConsolidado.objects.latest('id')
        
        return JsonResponse({
            'success': True,
            'data': {
                'id': consolidado.id,
                'valor': str(consolidado) if consolidado else 'N/A',
                'data_atualizacao': datetime.now().isoformat()
            }
        })
    except ChuvaConsolidado.DoesNotExist:
        return JsonResponse({
            'success': True,
            'data': {
                'valor': 'Sem dados',
                'data_atualizacao': datetime.now().isoformat()
            }
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e)
        }, status=500)


# ============================================
# APIs - EVENTOS (jÃ¡ existente, melhorada)
# ============================================

@never_cache
def api_eventos(request):
    """API de eventos da cidade"""
    try:
        eventos = Evento.objects.all()[:50]  # Ãšltimos 50 eventos
        
        data = []
        for evento in eventos:
            data.append({
                'id': evento.id,
                'nome': evento.nome if hasattr(evento, 'nome') else 'Evento',
                'tipo': evento.tipo if hasattr(evento, 'tipo') else 'geral',
                'lat': float(evento.lat) if hasattr(evento, 'lat') and evento.lat else -22.9068,
                'lng': float(evento.lon) if hasattr(evento, 'lon') and evento.lon else -43.1729,
                'data': evento.data.isoformat() if hasattr(evento, 'data') and evento.data else None,
                'prioridade': evento.prioridade if hasattr(evento, 'prioridade') else 'media',
                'local': evento.local if hasattr(evento, 'local') else ''
            })
        
        return JsonResponse({
            'success': True,
            'count': len(data),
            'data': data
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e),
            'data': []
        }, status=500)


# ============================================
# APIs - OCORRÃŠNCIAS (jÃ¡ existente, melhorada)
# ============================================

@never_cache
def api_ocorrencias(request):
    """API de ocorrÃªncias"""
    try:
        ocorrencias = Ocorrencias.objects.all().order_by('-id')[:50]
        
        data = []
        for oco in ocorrencias:
            data.append({
                'id': oco.id,
                'descricao': oco.descricao if hasattr(oco, 'descricao') else 'OcorrÃªncia',
                'tipo': oco.tipo if hasattr(oco, 'tipo') else 'geral',
                'lat': float(oco.lat) if hasattr(oco, 'lat') and oco.lat else -22.9068,
                'lng': float(oco.lon) if hasattr(oco, 'lon') and oco.lon else -43.1729,
                'status': oco.status if hasattr(oco, 'status') else 'aberta',
                'prioridade': oco.prioridade if hasattr(oco, 'prioridade') else 'media',
                'data': oco.data.isoformat() if hasattr(oco, 'data') and oco.data else None
            })
        
        return JsonResponse({
            'success': True,
            'count': len(data),
            'data': data
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'error': str(e),
            'data': []
        }, status=500)


# ============================================
# APIs - OUTRAS (Placeholder para expansÃ£o futura)
# ============================================

def api_escolas(request):
    """API de escolas (placeholder)"""
    return JsonResponse({'success': True, 'count': 0, 'data': []})

def api_hospitais(request):
    """API de hospitais (placeholder)"""
    return JsonResponse({'success': True, 'count': 0, 'data': []})



def waze_dashboard_completo(request):
    """Dashboard completo com todas as estatísticas"""
    from datetime import datetime
    
    # Dados mockados para o template antigo
    context = {
        'tamanho_4': 0,
        'pc': 0,
        'color_pc': '228d46',
        'hist': 0,
        'unz': [],
        'qt_unz': 0,
        'baixo_v': 0,
        'medio_v': 0,
        'alto_v': 0,
        'lista_estacoes_plv': [],
        'jams_linha': [],
        'escolas': [],
        'hospitais': [],
        'eventos': [],
        'ocorrencias': [],
        'sirenes': [],
        'abrigos': [],
        'alagamentos': [],
        'bens': [],
        'chuva': [],
        'lista_pontos': [],
        'sensores': []
    }
    
    return render(request, 'mapa_novo/waze_dashboard.html', context)

def cor_dashboard_view(request):
    """Dashboard com design COR profissional"""
    return render(request, 'mapa_novo/cor_dashboard.html')


@api_view(['GET'])
def pluviometros_view(request):
    """API de Pluviômetros - Estações de Chuva"""
    try:
        from aplicativo.models import EstacaoPlv, DadosPlv
        from datetime import datetime
        
        data = []
        estacoes = EstacaoPlv.objects.all()
        
        for estacao in estacoes:
            if estacao.lat and estacao.lon:
                ultimo = DadosPlv.objects.filter(estacao=estacao).order_by('-data').first()
                
                if ultimo:
                    # Tratar data (pode ser string ou datetime)
                    data_formatada = 'N/A'
                    if ultimo.data:
                        if isinstance(ultimo.data, str):
                            data_formatada = ultimo.data
                        else:
                            data_formatada = ultimo.data.strftime('%d/%m/%Y %H:%M')
                    
                    data.append({
                        'id': estacao.id,
                        'nome': estacao.nome,
                        'lat': float(estacao.lat),
                        'lng': float(estacao.lon),
                        'chuva_1h': float(ultimo.chuva_1 or 0),
                        'chuva_4h': float(ultimo.chuva_4 or 0),
                        'chuva_24h': float(ultimo.chuva_24 or 0),
                        'chuva_96h': float(ultimo.chuva_96 or 0),
                        'data': data_formatada,
                        'status': 'ativa'
                    })
        
        return Response({
            'success': True,
            'data': data,
            'count': len(data)
        })
        
    except Exception as e:
        import traceback
        print(f'ERRO: {e}')
        print(traceback.format_exc())
        return Response({
            'success': False,
            'error': str(e),
            'data': []
        }, status=500)

# api de Vento
@api_view(['GET'])
def estacoes_vento_view(request):
    """API de Estações de Vento"""
    try:
        from aplicativo.models import EstacaoMet, DadosMet
        
        data = []
        estacoes = EstacaoMet.objects.all()
        
        for estacao in estacoes:
            if estacao.lat and estacao.lon:
                ultimo = DadosMet.objects.filter(estacao=estacao).order_by('-data').first()
                
                if ultimo:
                    data.append({
                        'id': estacao.id,
                        'nome': estacao.nome,
                        'lat': float(estacao.lat),
                        'lng': float(estacao.lon),
                        'temperatura': float(ultimo.temp or 0),
                        'umidade': float(ultimo.umd or 0),
                        'direcao': str(ultimo.dire) if ultimo.dire else 'N/A',
                        'velocidade': float(ultimo.vel or 0),
                        'data': str(ultimo.data) if ultimo.data else 'N/A',
                        'status': 'ativa'
                    })
        
        return Response({
            'success': True,
            'data': data,
            'count': len(data)
        })
        
    except Exception as e:
        import traceback
        print(f'ERRO: {e}')
        print(traceback.format_exc())
        return Response({
            'success': False,
            'error': str(e),
            'data': []
        }, status=500)


@api_view(['GET'])
def escolas_view(request):
    """API de Escolas Municipais"""
    from aplicativo.models import EscolasMunicipais
    
    data = []
    for escola in EscolasMunicipais.objects.all():
        data.append({
            'id': escola.id,
            'nome': escola.nome,
            'lat': float(escola.y),
            'lng': float(escola.x),
            'endereco': str(escola.endereco or 'N/A'),
            'bairro': str(escola.bairro or 'N/A'),
            'telefone': str(escola.telefone or 'N/A'),
            'tipo': 'escola_municipal'
        })
    
    return Response({'success': True, 'data': data, 'count': len(data)})

@api_view(['GET'])
def bens_tombados_view(request):
    """API de Bens Tombados"""
    try:
        from aplicativo.models import BensProtegidos
        
        data = []
        bens = BensProtegidos.objects.all()
        
        for bem in bens:
            if bem.y and bem.x:
                data.append({
                    'id': bem.id,
                    'nome': bem.np or 'Bem Tombado',
                    'lat': float(bem.y),
                    'lng': float(bem.x),
                    'rua': bem.rua or 'N/A',
                    'grau': bem.grau_de_pr or 'N/A',
                    'tipo': 'bem_tombado'
                })
        
        return Response({'success': True, 'data': data, 'count': len(data)})
    except Exception as e:
        return Response({'success': False, 'error': str(e), 'data': []}, status=500)